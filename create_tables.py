"""
Supabase í…Œì´ë¸” ìƒì„± ìŠ¤í¬ë¦½íŠ¸
ì´ ìŠ¤í¬ë¦½íŠ¸ë¥¼ ì‹¤í–‰í•˜ë©´ Supabaseì— í•„ìš”í•œ í…Œì´ë¸”ì´ ìë™ìœ¼ë¡œ ìƒì„±ë©ë‹ˆë‹¤.
"""

import os
import sys
from supabase import create_client

# Windows ì½˜ì†” ì¸ì½”ë”© ì„¤ì •
if sys.platform == 'win32':
    sys.stdout.reconfigure(encoding='utf-8')

# Supabase ì—°ê²° ì •ë³´
SUPABASE_URL = "https://sbwwmartlnxadktagwvx.supabase.co"
SUPABASE_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InNid3dtYXJ0bG54YWRrdGFnd3Z4Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3Njc3NjM1MTgsImV4cCI6MjA4MzMzOTUxOH0.8EC0zI5p-xzTa0LKL2n7ICbUC2exvJaRYa5IkR4usEs"

# SQL ì¿¼ë¦¬
CREATE_TABLES_SQL = """
-- 1. ë³´í—˜ ìƒí’ˆ í…Œì´ë¸”
CREATE TABLE IF NOT EXISTS insurance_products (
    id bigint generated by default as identity primary key,
    created_at timestamp with time zone default timezone('utc'::text, now()) not null,
    product_name text not null,
    company text,
    analysis_data jsonb,
    user_id text
);

-- 2. ìƒë‹´ ì´ë ¥ í…Œì´ë¸”
CREATE TABLE IF NOT EXISTS consulting_history (
    id bigint generated by default as identity primary key,
    created_at timestamp with time zone default timezone('utc'::text, now()) not null,
    customer_name text,
    agent_name text,
    recommended_product_id bigint references insurance_products(id),
    analysis_result jsonb,
    user_id text
);

-- ì¸ë±ìŠ¤ ìƒì„± (ì„±ëŠ¥ í–¥ìƒ)
CREATE INDEX IF NOT EXISTS idx_insurance_products_created_at ON insurance_products(created_at DESC);
CREATE INDEX IF NOT EXISTS idx_consulting_history_created_at ON consulting_history(created_at DESC);
CREATE INDEX IF NOT EXISTS idx_consulting_history_customer_name ON consulting_history(customer_name);
"""

def create_tables():
    """Supabaseì— í…Œì´ë¸” ìƒì„±"""
    try:
        # Supabase í´ë¼ì´ì–¸íŠ¸ ìƒì„±
        supabase = create_client(SUPABASE_URL, SUPABASE_KEY)
        
        print("âœ… Supabase ì—°ê²° ì„±ê³µ!")
        print("ğŸ“‹ í…Œì´ë¸” ìƒì„± ì¤‘...")
        
        # SupabaseëŠ” RPCë¥¼ í†µí•´ SQL ì‹¤í–‰
        # í•˜ì§€ë§Œ ì§ì ‘ SQL ì‹¤í–‰ì€ ê´€ë¦¬ì ê¶Œí•œì´ í•„ìš”í•˜ë¯€ë¡œ
        # Supabase ê´€ë¦¬ APIë¥¼ ì‚¬ìš©í•˜ê±°ë‚˜ psycopg2ë¥¼ ì‚¬ìš©í•´ì•¼ í•©ë‹ˆë‹¤
        
        # ëŒ€ì‹  í…Œì´ë¸”ì´ ì¡´ì¬í•˜ëŠ”ì§€ í™•ì¸í•˜ê³  ì•ˆë‚´
        try:
            # í…Œì´ë¸” ì¡´ì¬ í™•ì¸
            result = supabase.table("insurance_products").select("id").limit(1).execute()
            print("âœ… insurance_products í…Œì´ë¸”ì´ ì´ë¯¸ ì¡´ì¬í•©ë‹ˆë‹¤.")
        except Exception:
            print("âš ï¸ insurance_products í…Œì´ë¸”ì´ ì—†ìŠµë‹ˆë‹¤.")
            print("\nğŸ’¡ Supabase ëŒ€ì‹œë³´ë“œì—ì„œ SQL Editorë¥¼ ì—´ê³  ë‹¤ìŒ SQLì„ ì‹¤í–‰í•˜ì„¸ìš”:\n")
            print(CREATE_TABLES_SQL)
            return False
        
        try:
            result = supabase.table("consulting_history").select("id").limit(1).execute()
            print("âœ… consulting_history í…Œì´ë¸”ì´ ì´ë¯¸ ì¡´ì¬í•©ë‹ˆë‹¤.")
        except Exception:
            print("âš ï¸ consulting_history í…Œì´ë¸”ì´ ì—†ìŠµë‹ˆë‹¤.")
            print("\nğŸ’¡ Supabase ëŒ€ì‹œë³´ë“œì—ì„œ SQL Editorë¥¼ ì—´ê³  ë‹¤ìŒ SQLì„ ì‹¤í–‰í•˜ì„¸ìš”:\n")
            print(CREATE_TABLES_SQL)
            return False
        
        print("\nâœ… ëª¨ë“  í…Œì´ë¸”ì´ ì¤€ë¹„ë˜ì—ˆìŠµë‹ˆë‹¤!")
        return True
        
    except Exception as e:
        print(f"âŒ ì˜¤ë¥˜ ë°œìƒ: {str(e)}")
        print("\nğŸ’¡ Supabase ëŒ€ì‹œë³´ë“œì—ì„œ SQL Editorë¥¼ ì—´ê³  ë‹¤ìŒ SQLì„ ì‹¤í–‰í•˜ì„¸ìš”:\n")
        print(CREATE_TABLES_SQL)
        return False

if __name__ == "__main__":
    print("ğŸš€ Supabase í…Œì´ë¸” ìƒì„± ìŠ¤í¬ë¦½íŠ¸ ì‹œì‘\n")
    create_tables()

