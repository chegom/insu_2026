"""
Enterprise AI Insurance Analyst (AI ë³´í—˜ ì •ë°€ ë¶„ì„ ë° ì»¨ì„¤íŒ… í”Œë«í¼)

ë°ì´í„°ë² ì´ìŠ¤ ì„¤ì • SQL (Supabaseì—ì„œ ì‹¤í–‰):
-- 1. ë³´í—˜ ìƒí’ˆ í…Œì´ë¸”
CREATE TABLE insurance_products (
    id bigint generated by default as identity primary key,
    created_at timestamp with time zone default timezone('utc'::text, now()) not null,
    product_name text not null,
    company text,
    analysis_data jsonb, -- AI ë¶„ì„ ê²°ê³¼ (ë³´ì¥ë‚´ì—­)
    user_id text -- ë“±ë¡í•œ ê´€ë¦¬ì ID (í˜„ì¬ëŠ” "admin-temp-id" ì‚¬ìš©)
);

-- 2. ìƒë‹´ ì´ë ¥ í…Œì´ë¸”
CREATE TABLE consulting_history (
    id bigint generated by default as identity primary key,
    created_at timestamp with time zone default timezone('utc'::text, now()) not null,
    customer_name text,
    agent_name text,
    recommended_product_id bigint references insurance_products(id),
    analysis_result jsonb, -- AI ë¹„êµ ë¶„ì„ ê²°ê³¼
    user_id text -- ìƒë‹´í•œ ì„¤ê³„ì‚¬ ID (í˜„ì¬ëŠ” "agent-temp-id" ì‚¬ìš©)
);
"""

import streamlit as st
import fitz  # PyMuPDF
import json
import time

# í˜ì´ì§€ ì„¤ì • ë° CSS (autocomplete ì†ì„± ì¶”ê°€)
st.set_page_config(
    page_title="Enterprise AI Insurance Analyst",
    page_icon="ğŸ“Š",
    layout="wide"
)

from typing import Dict, Optional, List
import pandas as pd
import plotly.express as px
from supabase import create_client, Client
import google.generativeai as genai

# JavaScriptë¥¼ ì‚¬ìš©í•˜ì—¬ ì…ë ¥ í•„ë“œì— autocomplete ì†ì„± ì¶”ê°€ (ìµœì¢… ê°•í™” ë²„ì „)
st.markdown("""
<script>
(function() {
    'use strict';
    
    function setAutocompleteAttributes() {
        try {
            // ëª¨ë“  ì…ë ¥ í•„ë“œì™€ select ìš”ì†Œ ì°¾ê¸°
            const allInputs = document.querySelectorAll('input[type="text"], input[type="number"], input[type="email"], select');
            let updatedCount = 0;
            
            allInputs.forEach(function(input) {
                try {
                    // ì´ë¯¸ ìœ íš¨í•œ autocompleteê°€ ìˆìœ¼ë©´ ìŠ¤í‚µ
                    const currentAutocomplete = input.getAttribute('autocomplete');
                    if (currentAutocomplete && currentAutocomplete !== '' && currentAutocomplete !== 'null' && currentAutocomplete !== 'undefined') {
                        return;
                    }
                    
                    const testId = (input.getAttribute('data-testid') || '').toLowerCase();
                    const name = (input.getAttribute('name') || '').toLowerCase();
                    const id = (input.getAttribute('id') || '').toLowerCase();
                    const placeholder = (input.getAttribute('placeholder') || '').toLowerCase();
                    const label = (input.closest('label')?.textContent || '').toLowerCase();
                    
                    let autocompleteValue = 'off'; // ê¸°ë³¸ê°’
                    
                    // ê³ ê°ëª…, ì„¤ê³„ì‚¬ëª…, ì´ë¦„ ê´€ë ¨
                    if (testId.includes('customer_name') || testId.includes('agent_name') || 
                        testId.includes('search_customer') || name.includes('name') || 
                        label.includes('ê³ ê°ëª…') || label.includes('ì„¤ê³„ì‚¬ëª…') || label.includes('ì´ë¦„')) {
                        autocompleteValue = 'name';
                    }
                    // ì„±ë³„
                    else if (testId.includes('gender') || name.includes('gender') || name.includes('sex') || 
                             label.includes('ì„±ë³„')) {
                        autocompleteValue = 'sex';
                    }
                    // ë‚˜ì´
                    else if (testId.includes('age') || name.includes('age') || label.includes('ë‚˜ì´')) {
                        autocompleteValue = 'off';
                    }
                    // ì›”ìˆ˜ì…, ìˆ˜ì…
                    else if (testId.includes('income') || testId.includes('monthly') || 
                             name.includes('income') || label.includes('ìˆ˜ì…')) {
                        autocompleteValue = 'transaction-amount';
                    }
                    // ìƒí’ˆëª…
                    else if (testId.includes('product_name') || testId.includes('edit_name') || 
                             name.includes('product') || label.includes('ìƒí’ˆëª…')) {
                        autocompleteValue = 'organization-title';
                    }
                    // ë³´í—˜ì‚¬ëª…, íšŒì‚¬ëª…
                    else if (testId.includes('company') || name.includes('company') || 
                             label.includes('ë³´í—˜ì‚¬') || label.includes('íšŒì‚¬')) {
                        autocompleteValue = 'organization';
                    }
                    
                    // autocomplete ì†ì„± ì„¤ì •
                    input.setAttribute('autocomplete', autocompleteValue);
                    updatedCount++;
                } catch (e) {
                    console.warn('Autocomplete ì„¤ì • ì˜¤ë¥˜:', e);
                }
            });
            
            // ë¹ˆ autocomplete ì†ì„± ì œê±° (ê²½ê³  ë°©ì§€) - ë” ê°•í™”
            const emptyAutocomplete = document.querySelectorAll('[autocomplete=""], [autocomplete="null"], [autocomplete="undefined"]');
            emptyAutocomplete.forEach(function(el) {
                el.setAttribute('autocomplete', 'off');
            });
            
            // autocomplete ì†ì„±ì´ ì—†ëŠ” input í•„ë“œì—ë„ ê¸°ë³¸ê°’ ì„¤ì •
            const inputsWithoutAutocomplete = document.querySelectorAll('input:not([autocomplete]), select:not([autocomplete])');
            inputsWithoutAutocomplete.forEach(function(el) {
                if (el.tagName === 'INPUT' || el.tagName === 'SELECT') {
                    el.setAttribute('autocomplete', 'off');
                }
            });
            
            if (updatedCount > 0) {
                console.log(`Autocomplete ì†ì„± ì„¤ì • ì™„ë£Œ: ${updatedCount}ê°œ í•„ë“œ`);
            }
        } catch (e) {
            console.error('Autocomplete ì„¤ì • í•¨ìˆ˜ ì˜¤ë¥˜:', e);
        }
    }
    
    // ì¦‰ì‹œ ì‹¤í–‰
    if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', function() {
            setAutocompleteAttributes();
            // ì¶”ê°€ë¡œ ì•½ê°„ì˜ ì§€ì—° í›„ ì¬ì‹¤í–‰
            setTimeout(setAutocompleteAttributes, 100);
            setTimeout(setAutocompleteAttributes, 500);
        });
    } else {
        setAutocompleteAttributes();
        setTimeout(setAutocompleteAttributes, 100);
        setTimeout(setAutocompleteAttributes, 500);
    }
    
    // window.load ì´ë²¤íŠ¸
    window.addEventListener('load', function() {
        setAutocompleteAttributes();
        setTimeout(setAutocompleteAttributes, 200);
    });
    
    // MutationObserverë¡œ DOM ë³€ê²½ ê°ì§€ (ë” ê³µê²©ì ìœ¼ë¡œ)
    const observer = new MutationObserver(function(mutations) {
        let hasNewNodes = false;
        mutations.forEach(function(mutation) {
            if (mutation.addedNodes.length > 0) {
                hasNewNodes = true;
            }
            // ì†ì„± ë³€ê²½ë„ ê°ì§€
            if (mutation.type === 'attributes' && mutation.attributeName === 'data-testid') {
                hasNewNodes = true;
            }
        });
        if (hasNewNodes) {
            setTimeout(setAutocompleteAttributes, 50);
            setTimeout(setAutocompleteAttributes, 200);
            setTimeout(setAutocompleteAttributes, 500);
        }
    });
    
    observer.observe(document.body, {
        childList: true,
        subtree: true,
        attributes: true,
        attributeFilter: ['data-testid', 'name', 'id']
    });
    
    // ì£¼ê¸°ì ìœ¼ë¡œ í™•ì¸ (Streamlitì˜ ë™ì  ì—…ë°ì´íŠ¸ ëŒ€ì‘)
    setInterval(function() {
        setAutocompleteAttributes();
    }, 2000);
    
    // Streamlitì˜ íŠ¹ì • ì´ë²¤íŠ¸ í›„ì—ë„ ì‹¤í–‰
    if (window.parent) {
        window.parent.addEventListener('message', function(event) {
            if (event.data && event.data.type === 'streamlit:render') {
                setTimeout(setAutocompleteAttributes, 100);
            }
        });
    }
})();
</script>
""", unsafe_allow_html=True)

# Streamlit secretsì—ì„œ ì„¤ì • ê°€ì ¸ì˜¤ê¸°
try:
    SUPABASE_URL = st.secrets.get("supabase", {}).get("url")
    SUPABASE_KEY = st.secrets.get("supabase", {}).get("key")
    GEMINI_API_KEY = st.secrets.get("google", {}).get("api_key")
except Exception as e:
    st.warning(f"âš ï¸ ì„¤ì • íŒŒì¼ ì½ê¸° ì˜¤ë¥˜: {str(e)}")
    SUPABASE_URL = None
    SUPABASE_KEY = None
    GEMINI_API_KEY = None

# ê³ ì • user_id ê°’
ADMIN_USER_ID = "admin-temp-id"
AGENT_USER_ID = "agent-temp-id"

# Supabase í´ë¼ì´ì–¸íŠ¸ ì´ˆê¸°í™” (ì—ëŸ¬ ì²˜ë¦¬ ê°•í™”)
# @st.cache_resource ì œê±° - ìºì‹±ìœ¼ë¡œ ì¸í•œ ë¬¸ì œ ë°©ì§€
def init_supabase():
    """Supabase í´ë¼ì´ì–¸íŠ¸ ì´ˆê¸°í™”"""
    try:
        if not SUPABASE_URL or not SUPABASE_KEY:
            st.warning("âš ï¸ Supabase ì„¤ì •ì´ í•„ìš”í•©ë‹ˆë‹¤. `.streamlit/secrets.toml` íŒŒì¼ì— Supabase URLê³¼ Keyë¥¼ ì„¤ì •í•´ì£¼ì„¸ìš”.")
            return None
        client = create_client(SUPABASE_URL, SUPABASE_KEY)
        # ì—°ê²° í…ŒìŠ¤íŠ¸
        try:
            client.table("insurance_products").select("id").limit(1).execute()
        except Exception:
            # í…Œì´ë¸”ì´ ì—†ì„ ìˆ˜ ìˆìœ¼ë¯€ë¡œ ê²½ê³ ë§Œ í‘œì‹œ
            pass  # ì¡°ìš©íˆ ë„˜ì–´ê°
        return client
    except Exception as e:
        st.error(f"âš ï¸ Supabase ì—°ê²° ì‹¤íŒ¨: {str(e)}")
        st.info("ğŸ’¡ í™•ì¸ì‚¬í•­:\n- Supabase í”„ë¡œì íŠ¸ URLê³¼ Keyê°€ ì˜¬ë°”ë¥¸ì§€ í™•ì¸í•˜ì„¸ìš”.\n- ë°ì´í„°ë² ì´ìŠ¤ í…Œì´ë¸”ì´ ìƒì„±ë˜ì—ˆëŠ”ì§€ í™•ì¸í•˜ì„¸ìš”.")
        return None

# Gemini AI ì´ˆê¸°í™” (ì—ëŸ¬ ì²˜ë¦¬ ê°•í™”)
def init_gemini():
    """Gemini AI ëª¨ë¸ ì´ˆê¸°í™”"""
    try:
        if not GEMINI_API_KEY:
            st.warning("âš ï¸ Gemini API í‚¤ê°€ í•„ìš”í•©ë‹ˆë‹¤. `.streamlit/secrets.toml` íŒŒì¼ì— [google] api_keyë¥¼ ì„¤ì •í•´ì£¼ì„¸ìš”.")
            return None
        
        genai.configure(api_key=GEMINI_API_KEY)
        
        # ì‹¤ì œ ì‚¬ìš© ê°€ëŠ¥í•œ ëª¨ë¸ ëª©ë¡ í™•ì¸
        try:
            models = genai.list_models()
            available_models = []
            for m in models:
                if 'generateContent' in m.supported_generation_methods:
                    model_name = m.name.replace('models/', '')
                    available_models.append(model_name)
            
            if available_models:
                st.info(f"ğŸ“‹ ì‚¬ìš© ê°€ëŠ¥í•œ ëª¨ë¸: {', '.join(available_models[:5])}...")
                
                # ì‚¬ìš© ê°€ëŠ¥í•œ ëª¨ë¸ ì¤‘ì—ì„œ ì„ íƒ (ìš°ì„ ìˆœìœ„: flash > pro)
                model_name = None
                preferred_order = ['gemini-1.5-flash', 'gemini-1.5-pro', 'gemini-pro']
                
                for preferred in preferred_order:
                    for available in available_models:
                        if preferred in available.lower():
                            model_name = available
                            break
                    if model_name:
                        break
                
                if not model_name:
                    # ì²« ë²ˆì§¸ ì‚¬ìš© ê°€ëŠ¥í•œ ëª¨ë¸ ì‚¬ìš©
                    model_name = available_models[0]
                
                try:
                    model = genai.GenerativeModel(model_name)
                    # ê°„ë‹¨í•œ í…ŒìŠ¤íŠ¸ (í• ë‹¹ëŸ‰ ì ˆì•½ì„ ìœ„í•´ ë§¤ìš° ì§§ì€ í…ìŠ¤íŠ¸)
                    test_response = model.generate_content("hi")
                    st.success(f"âœ… Gemini ëª¨ë¸ ì´ˆê¸°í™” ì„±ê³µ: {model_name}")
                    return model
                except Exception as model_error:
                    error_str = str(model_error)
                    if "429" in error_str or "quota" in error_str.lower() or "rate" in error_str.lower():
                        st.error("âš ï¸ Gemini API í• ë‹¹ëŸ‰ ì´ˆê³¼")
                        st.info("ğŸ’¡ í•´ê²° ë°©ë²•:\n- ì ì‹œ í›„ ë‹¤ì‹œ ì‹œë„í•˜ì„¸ìš” (ëª‡ ë¶„ ëŒ€ê¸°)\n- Google AI Studioì—ì„œ ì‚¬ìš©ëŸ‰ í™•ì¸: https://ai.dev/usage\n- ë¬´ë£Œ ì²´í—˜íŒì´ í™œì„±í™”ë˜ì—ˆëŠ”ì§€ í™•ì¸í•˜ì„¸ìš”")
                    else:
                        st.error(f"âš ï¸ ëª¨ë¸ ì´ˆê¸°í™” ì‹¤íŒ¨ ({model_name}): {str(model_error)}")
                    return None
            else:
                st.error("âš ï¸ ì‚¬ìš© ê°€ëŠ¥í•œ ëª¨ë¸ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.")
                return None
        except Exception as list_error:
            # ëª¨ë¸ ëª©ë¡ ì¡°íšŒ ì‹¤íŒ¨ ì‹œ ì§ì ‘ ì‹œë„
            error_str = str(list_error)
            if "429" in error_str or "quota" in error_str.lower():
                st.error("âš ï¸ Gemini API í• ë‹¹ëŸ‰ ì´ˆê³¼ (ëª¨ë¸ ëª©ë¡ ì¡°íšŒ ì‹¤íŒ¨)")
                st.info("ğŸ’¡ í•´ê²° ë°©ë²•:\n- ì ì‹œ í›„ ë‹¤ì‹œ ì‹œë„í•˜ì„¸ìš”\n- Google AI Studioì—ì„œ ì‚¬ìš©ëŸ‰ í™•ì¸: https://ai.dev/usage\n- ë¬´ë£Œ ì²´í—˜íŒì´ í™œì„±í™”ë˜ì—ˆëŠ”ì§€ í™•ì¸í•˜ì„¸ìš”")
            else:
                st.warning(f"ëª¨ë¸ ëª©ë¡ ì¡°íšŒ ì‹¤íŒ¨: {str(list_error)}")
                # ê¸°ë³¸ ëª¨ë¸ ì‹œë„
                try:
                    model = genai.GenerativeModel('gemini-pro')
                    test_response = model.generate_content("test")
                    st.success("âœ… Gemini ëª¨ë¸ ì´ˆê¸°í™” ì„±ê³µ: gemini-pro")
                    return model
                except Exception as e:
                    st.error(f"âš ï¸ Gemini API ì´ˆê¸°í™” ì‹¤íŒ¨: {str(e)}")
            return None
    except Exception as e:
        st.error(f"âš ï¸ Gemini API ì´ˆê¸°í™” ì‹¤íŒ¨: {str(e)}")
        st.info("ğŸ’¡ í™•ì¸ì‚¬í•­:\n- Gemini API í‚¤ê°€ ì˜¬ë°”ë¥¸ì§€ í™•ì¸í•˜ì„¸ìš”.\n- API ì‚¬ìš©ëŸ‰ ì œí•œì„ í™•ì¸í•˜ì„¸ìš”.")
        return None

# Supabase í´ë¼ì´ì–¸íŠ¸ ì´ˆê¸°í™” (ì„¸ì…˜ ìƒíƒœì— ì €ì¥í•˜ì—¬ ì¬ì‚¬ìš©)
if 'supabase_client' not in st.session_state:
    st.session_state['supabase_client'] = init_supabase()
supabase: Optional[Client] = st.session_state.get('supabase_client')
# GeminiëŠ” í•¨ìˆ˜ ë‚´ì—ì„œ í•„ìš”í•  ë•Œë§ˆë‹¤ ì´ˆê¸°í™”í•˜ë„ë¡ ë³€ê²½
gemini_model = None

def _extract_amount(amount_str: str) -> float:
    """ê¸ˆì•¡ ë¬¸ìì—´ì—ì„œ ìˆ«ì ì¶”ì¶œ (ë§Œì› ë‹¨ìœ„ë¡œ ë³€í™˜)"""
    import re
    if not amount_str or amount_str == '0':
        return 0.0
    
    # ìˆ«ìë§Œ ì¶”ì¶œ
    numbers = re.findall(r'[\d,]+', str(amount_str).replace(',', ''))
    if numbers:
        try:
            value = float(numbers[0])
            # ë§Œì› ë‹¨ìœ„ë¡œ ë³€í™˜ (ì˜ˆ: 1000ë§Œì› -> 1000)
            if 'ì–µ' in str(amount_str):
                value *= 10000
            elif 'ì²œ' in str(amount_str) and 'ë§Œ' not in str(amount_str):
                value /= 10
            return value
        except:
            return 0.0
    return 0.0

def _parse_json_with_retry(text: str, max_retries: int = 3) -> Dict:
    """JSON íŒŒì‹± ì‹œë„ (ì¬ì‹œë„ ë¡œì§ í¬í•¨)"""
    for attempt in range(max_retries):
        try:
            # JSON ì¶”ì¶œ ì‹œë„
            if "```json" in text:
                json_start = text.find("```json") + 7
                json_end = text.find("```", json_start)
                json_text = text[json_start:json_end].strip()
            elif "```" in text:
                json_start = text.find("```") + 3
                json_end = text.find("```", json_start)
                json_text = text[json_start:json_end].strip()
            else:
                json_text = text.strip()
            
            # JSON íŒŒì‹±
            return json.loads(json_text)
        except json.JSONDecodeError as e:
            if attempt < max_retries - 1:
                # ë§ˆì§€ë§‰ ì‹œë„ê°€ ì•„ë‹ˆë©´ ì ì‹œ ëŒ€ê¸° í›„ ì¬ì‹œë„
                time.sleep(0.5)
                continue
            else:
                # ëª¨ë“  ì‹œë„ ì‹¤íŒ¨ ì‹œ ì›ë³¸ í…ìŠ¤íŠ¸ ë°˜í™˜
                st.warning(f"âš ï¸ JSON íŒŒì‹± ì‹¤íŒ¨ (ì‹œë„ {max_retries}íšŒ). ì›ë³¸ í…ìŠ¤íŠ¸ë¥¼ ë°˜í™˜í•©ë‹ˆë‹¤.")
                return {"raw_analysis": text, "parse_error": str(e)}
        except Exception as e:
            st.error(f"JSON íŒŒì‹± ì¤‘ ì˜ˆìƒì¹˜ ëª»í•œ ì˜¤ë¥˜: {str(e)}")
            return {"raw_analysis": text, "error": str(e)}
    
    return {"raw_analysis": text}

@st.cache_data
def extract_text_from_pdf(pdf_file_bytes: bytes, file_name: str) -> str:
    """PDF íŒŒì¼ì—ì„œ í…ìŠ¤íŠ¸ ì¶”ì¶œ (PyMuPDF ì‚¬ìš©) - ìµœì í™” ë²„ì „"""
    try:
        doc = fitz.open(stream=pdf_file_bytes, filetype="pdf")
        total_pages = len(doc)
        text = ""
        progress_bar = st.progress(0)
        status_text = st.empty()
        
        for page_num in range(total_pages):
            page = doc[page_num]
            text += page.get_text()
            # ì§„í–‰ë¥  ì—…ë°ì´íŠ¸
            progress = (page_num + 1) / total_pages
            progress_bar.progress(progress)
            status_text.text(f"í˜ì´ì§€ {page_num + 1}/{total_pages} ì²˜ë¦¬ ì¤‘...")
        
        doc.close()  # ë©”ëª¨ë¦¬ ëˆ„ìˆ˜ ë°©ì§€
        progress_bar.empty()
        status_text.empty()
        return text
    except Exception as e:
        st.error(f"PDF í…ìŠ¤íŠ¸ ì¶”ì¶œ ì˜¤ë¥˜: {str(e)}")
        return ""

def analyze_insurance_terms(text: str) -> Dict:
    """AIë¥¼ ì‚¬ìš©í•˜ì—¬ ë³´í—˜ ì•½ê´€ ë¶„ì„"""
    model = init_gemini()
    if not model:
        return {}
    
    prompt = """# Role Definition

ë„ˆëŠ” 20ë…„ ê²½ë ¥ì˜ ë³´í—˜ ìƒí’ˆ ê¸°íšìì´ì ìˆ˜ì„ ì†í•´ì‚¬ì •ì‚¬ì•¼.

ì—…ë¡œë“œëœ **ë³´í—˜ ì•½ê´€(PDF)**ì„ ì •ë°€ ë¶„ì„í•˜ì—¬, í–¥í›„ ê³ ê°ì˜ ê¸°ì¡´ ë³´í—˜ê³¼ 'ë³´ì¥ ë²”ìœ„(Scope)'ë¥¼ ë¹„êµí•  ìˆ˜ ìˆëŠ” **[ë§ˆìŠ¤í„° ë°ì´í„°]**ë¥¼ êµ¬ì¶•í•˜ë ¤ê³  í•´.

# Task Goal

ì•½ê´€ì˜ ë°©ëŒ€í•œ í…ìŠ¤íŠ¸ ì¤‘ì—ì„œ **'ë³´ì¥ì˜ ì§ˆ(Quality)'**ì„ ê²°ì •í•˜ëŠ” í•µì‹¬ ìš”ì†Œë“¤ì„ ì¶”ì¶œí•˜ì—¬ ì™„ë²½í•œ JSON í¬ë§·ìœ¼ë¡œ ë°˜í™˜í•´.

(ì£¼ì˜: ê°€ì…ê¸ˆì•¡ì€ ê°€ì…ìë§ˆë‹¤ ë‹¤ë¥´ë¯€ë¡œ, êµ¬ì²´ì ì¸ ê¸ˆì•¡ë³´ë‹¤ëŠ” **'ì§€ê¸‰ ì‚¬ìœ ', 'ëŒ€ìƒ ì§ˆë³‘ ì½”ë“œ', 'ì§€ê¸‰ ì œí•œ ì¡°ê±´'**ì— ì§‘ì¤‘í•´.)

# Extraction Rules (JSON Schema)

ë°˜ë“œì‹œ ì•„ë˜ êµ¬ì¡°ë¥¼ ì¤€ìˆ˜í•˜ì—¬ JSON ë°ì´í„°ë¥¼ ìƒì„±í•´.

{
  "meta_info": {
    "product_name": "ìƒí’ˆëª… (í’€ë„¤ì„)",
    "company": "ë³´í—˜ì‚¬ëª…",
    "product_type": "ê°±ì‹ í˜•/ë¹„ê°±ì‹ í˜•/ì—°ë§Œê¸° ë“± êµ¬ì¡° íŒŒì•…",
    "renewal_period": "ê°±ì‹  ì£¼ê¸° (ì˜ˆ: 20ë…„, 3ë…„, í•´ë‹¹ ì—†ìœ¼ë©´ null)"
  },
  "core_scope": {
    "cancer": {
      "definition": "ì¼ë°˜ì•”ì˜ ì •ì˜ ìš”ì•½",
      "micro_cancer": "ìœ ì‚¬ì•”/ì†Œì•¡ì•”ìœ¼ë¡œ ë¶„ë¥˜ë˜ëŠ” ì•” ì¢…ë¥˜ (ì˜ˆ: ê°‘ìƒì„ ì•”, ê¸°íƒ€í”¼ë¶€ì•”, ì œìë¦¬ì•”, ê²½ê³„ì„±ì¢…ì–‘)",
      "exemption_period": "ë©´ì±…ê¸°ê°„ (ì¼ìˆ˜, ì˜ˆ: 90)",
      "reduction_period": "ê°ì•¡ê¸°ê°„ ì¡°ê±´ (ì˜ˆ: 1ë…„ ë¯¸ë§Œ 50% ì§€ê¸‰)"
    },
    "brain": {
      "scope_level": "ë³´ì¥ ë²”ìœ„ ë“±ê¸‰ (ë‡Œì¶œí˜ˆ < ë‡Œì¡¸ì¤‘ < ë‡Œí˜ˆê´€ì§ˆí™˜ ì¤‘ ì„ íƒ)",
      "covered_codes": "ì•½ê´€í‘œì— ëª…ì‹œëœ ëŒ€ìƒ ì§ˆë³‘ë¶„ë¥˜ì½”ë“œ ì˜ˆì‹œ (ì˜ˆ: I60~I69)",
      "features": "íŠ¹ì´ì‚¬í•­ (ì˜ˆ: ë‡Œë™ë§¥ë¥˜ ìˆ˜ìˆ  í¬í•¨ ì—¬ë¶€)"
    },
    "heart": {
      "scope_level": "ë³´ì¥ ë²”ìœ„ ë“±ê¸‰ (ê¸‰ì„±ì‹¬ê·¼ê²½ìƒ‰ < í—ˆí˜ˆì„±ì‹¬ì¥ì§ˆí™˜ < ì‹¬í˜ˆê´€ì§ˆí™˜ ì¤‘ ì„ íƒ)",
      "covered_codes": "ì•½ê´€í‘œì— ëª…ì‹œëœ ëŒ€ìƒ ì§ˆë³‘ë¶„ë¥˜ì½”ë“œ ì˜ˆì‹œ (ì˜ˆ: I20~I25)",
      "features": "íŠ¹ì´ì‚¬í•­ (ì˜ˆ: ë¶€ì •ë§¥, ì‹¬ë¶€ì „ í¬í•¨ ì—¬ë¶€)"
    }
  },
  "surgery_benefits": {
    "type_1_5": "1~5ì¢… ìˆ˜ìˆ ë¹„ íŠ¹ì•½ ì¡´ì¬ ì—¬ë¶€ (true/false)",
    "n_diseases": "NëŒ€ ì§ˆë³‘ ìˆ˜ìˆ ë¹„ ì¡´ì¬ ì—¬ë¶€ (ì˜ˆ: 112ëŒ€, 119ëŒ€ ë“± ìˆ«ì ê¸°ì¬)"
  },
  "premium_waiver": {
    "conditions": ["ë‚©ì…ë©´ì œê°€ ë˜ëŠ” ì‚¬ìœ  ë¦¬ìŠ¤íŠ¸ (ì˜ˆ: ì•” ì§„ë‹¨ ì‹œ, ë‡Œì¡¸ì¤‘ ì§„ë‹¨ ì‹œ, 80% ì´ìƒ í›„ìœ ì¥í•´ ì‹œ)"]
  },
  "selling_points": [
    "ì´ ìƒí’ˆë§Œì´ ê°€ì§„ ì°¨ë³„í™”ëœ íŠ¹ì¥ì  1",
    "ì´ ìƒí’ˆë§Œì´ ê°€ì§„ ì°¨ë³„í™”ëœ íŠ¹ì¥ì  2"
  ],
  "exclusions": [
    "ë©´ì±…ì‚¬í•­ 1",
    "ë©´ì±…ì‚¬í•­ 2"
  ]
}

ë°˜ë“œì‹œ JSON í˜•ì‹ë§Œ ì¶œë ¥í•˜ê³ , ë‹¤ë¥¸ ì„¤ëª…ì€ í¬í•¨í•˜ì§€ ë§ˆ.

ì•½ê´€ í…ìŠ¤íŠ¸:
""" + text[:100000]  # í• ë‹¹ëŸ‰ ì ˆì•½ì„ ìœ„í•´ í…ìŠ¤íŠ¸ ê¸¸ì´ ì œí•œ (10ë§Œì)
    
    try:
        # ì¬ì‹œë„ ë¡œì§ (í• ë‹¹ëŸ‰ ì´ˆê³¼ ì‹œ)
        max_retries = 3
        retry_delay = 5  # ì´ˆê¸° ëŒ€ê¸° ì‹œê°„ (ì´ˆ)
        
        for attempt in range(max_retries):
            try:
                response = model.generate_content(prompt)
                result_text = response.text
                return _parse_json_with_retry(result_text)
            except Exception as e:
                error_str = str(e)
                # í• ë‹¹ëŸ‰ ì´ˆê³¼ ì˜¤ë¥˜ì¸ ê²½ìš° ì¬ì‹œë„
                if ("429" in error_str or "quota" in error_str.lower() or "rate" in error_str.lower()) and attempt < max_retries - 1:
                    # ì¬ì‹œë„ ëŒ€ê¸° ì‹œê°„ ì¶”ì¶œ ë˜ëŠ” ê¸°ë³¸ê°’ ì‚¬ìš©
                    wait_time = retry_delay * (attempt + 1)  # ì§€ìˆ˜ ë°±ì˜¤í”„
                    st.warning(f"âš ï¸ í• ë‹¹ëŸ‰ ì´ˆê³¼. {wait_time}ì´ˆ í›„ ì¬ì‹œë„í•©ë‹ˆë‹¤... (ì‹œë„ {attempt + 1}/{max_retries})")
                    time.sleep(wait_time)
                    continue
                else:
                    # ë‹¤ë¥¸ ì˜¤ë¥˜ì´ê±°ë‚˜ ìµœëŒ€ ì¬ì‹œë„ íšŸìˆ˜ ì´ˆê³¼
                    raise e
    except Exception as e:
        error_str = str(e)
        if "429" in error_str or "quota" in error_str.lower():
            st.error("âš ï¸ AI ë¶„ì„ ì˜¤ë¥˜: í• ë‹¹ëŸ‰ ì´ˆê³¼")
            st.info("ğŸ’¡ ì ì‹œ í›„ ë‹¤ì‹œ ì‹œë„í•˜ê±°ë‚˜, ë” ì‘ì€ í…ìŠ¤íŠ¸ë¡œ ë¶„ì„í•´ë³´ì„¸ìš”.\nì‚¬ìš©ëŸ‰ í™•ì¸: https://ai.dev/usage")
        else:
            st.error(f"AI ë¶„ì„ ì˜¤ë¥˜: {str(e)}")
        return {}

def analyze_customer_policy(text: str, customer_info: Dict = None) -> Dict:
    """ê³ ê°ì˜ ë³´ì¥ë¶„ì„ ë¦¬í¬íŠ¸ ë¶„ì„ (AS-IS)"""
    model = init_gemini()
    if not model:
        return {}
    
    prompt = """# Role Definition

ë„ˆëŠ” 20ë…„ ê²½ë ¥ì˜ ë² í…Œë‘ ë³´í—˜ ì¬ë¬´ì„¤ê³„ì‚¬ì•¼.

ì—…ë¡œë“œëœ **[ê³ ê° ë³´ì¥ë¶„ì„ ë¦¬í¬íŠ¸ PDF]**ë¥¼ ì •ë°€ ë¶„ì„í•˜ì—¬, ê³ ê°ì˜ í˜„ì¬ ë³´í—˜ ìƒíƒœ(AS-IS)ë¥¼ ì§„ë‹¨í•˜ê³  ë°ì´í„°í™”í•´ì¤˜.

# Task Goal

ì´ ë¦¬í¬íŠ¸ëŠ” ê³ ê°ì´ í˜„ì¬ ê°€ì…í•œ ë³´í—˜ì˜ ë‚´ì—­ì„ ë³´ì—¬ì£¼ê³  ìˆì–´.

ì—¬ê¸°ì„œ **1) ê¸°ë³¸ ì¸ì ì‚¬í•­**, **2) ì´ ë‚©ì… ë³´í—˜ë£Œ**, **3) ì£¼ìš” ë‹´ë³´ë³„ ê°€ì… ê¸ˆì•¡**ì„ ì¶”ì¶œí•˜ì—¬ JSONìœ¼ë¡œ ì •ë¦¬í•´.

íŠ¹íˆ, ê°€ì…ë˜ì–´ ìˆì§€ ì•Šê±°ë‚˜(0ì›), ë³´ì¥ ë²”ìœ„ê°€ ì¢ì€ ë‹´ë³´(ì˜ˆ: ë‡Œí˜ˆê´€ ëŒ€ì‹  ë‡Œì¶œí˜ˆë§Œ ê°€ì…)ë¥¼ ì‹ë³„í•˜ëŠ” ê²ƒì´ ê°€ì¥ ì¤‘ìš”í•´.

# Extraction Rules (JSON Schema)

ë°˜ë“œì‹œ ì•„ë˜ êµ¬ì¡°ë¥¼ ì¤€ìˆ˜í•˜ì—¬ JSON ë°ì´í„°ë¥¼ ìƒì„±í•´. ê¸ˆì•¡ì€ 'ë§Œì›' ë‹¨ìœ„ ìˆ«ìë§Œ ë‚¨ê²¨. (ì˜ˆ: 10,000,000 -> 1000)

{
  "customer_profile": {
    "name": "ê³ ê°ëª…",
    "age": 0,
    "gender": "ë‚¨/ì—¬",
    "total_monthly_premium": 0,
    "monthly_income": 0,
    "premium_ratio": 0,
    "premium_status": "ë¶€ì¡±/ì ì •/ê³¼ë‹¤",
    "premium_comment": "ì›”ìˆ˜ì… ëŒ€ë¹„ ë³´í—˜ë£Œ ë¹„ìœ¨ í‰ê°€ (í‰ê·  8~12% ê¸°ì¤€)"
  },
  "insurance_list": [
    {
      "insurance_name": "ë³´í—˜ëª…",
      "insurance_type": "ë³´í—˜ ì¢…ë¥˜ (ì˜ˆ: ì¢…ì‹ ë³´í—˜, ì‹¤ì†ë³´í—˜ ë“±)",
      "payment_period": "ë‚©ì…ê¸°ê°„ (ì˜ˆ: 20ë…„ë‚©, ì „ê¸°ë‚© ë“±)",
      "coverage_period": "ë³´í—˜ê¸°ê°„ (ì˜ˆ: ì¢…ì‹ , 80ì„¸ë§Œê¸° ë“±)",
      "monthly_premium": 0,
      "description": "ë³´í—˜ì— ëŒ€í•œ ì„¤ëª… ë° ì£¼ìš” ë³´ì¥ ë‚´ìš©"
    }
  ],
  "coverage_status": {
    "cancer": {
      "general_amount": 0,
      "micro_amount": 0,
      "is_sufficient": true
    },
    "brain": {
      "hemorrhage_amount": 0,
      "stroke_amount": 0,
      "vascular_amount": 0,
      "diagnosis": "ë³´ì¥ ë²”ìœ„ í‰ê°€ (ì˜ˆ: ë‡Œì¶œí˜ˆë§Œ ê°€ì…ë˜ì–´ ë³´ì¥ ë²”ìœ„ê°€ ë§¤ìš° í˜‘ì†Œí•¨)"
    },
    "heart": {
      "acute_amount": 0,
      "ischemic_amount": 0,
      "diagnosis": "ë³´ì¥ ë²”ìœ„ í‰ê°€"
    },
    "surgery": {
      "disease_surgery_amount": 0,
      "injury_surgery_amount": 0,
      "type_1_5_exist": true
    },
    "hospitalization": {
      "daily_amount": 0
    }
  },
  "weak_points": [
    "í˜„ì¬ ë³´ì¥ì—ì„œ ë¶€ì¡±í•˜ê±°ë‚˜ ì•„ì‰¬ìš´ ì  3ê°€ì§€ (ì˜ˆ: ë‡Œí˜ˆê´€ ì§„ë‹¨ë¹„ ë¶€ì¬, ìˆ˜ìˆ ë¹„ ë³´ì¥ ê¸ˆì•¡ ë¶€ì¡± ë“±)"
  ]
}

# Critical Instructions

1. ë¬¸ì„œì— 'ê°€ì…', 'ë³´ìœ ', 'ì¤€ë¹„' ë“±ìœ¼ë¡œ í‘œê¸°ëœ ê¸ˆì•¡ì„ ì°¾ì•„ì„œ ë§¤í•‘í•´.
2. ê¸ˆì•¡ì´ ì í˜€ìˆì§€ ì•Šê±°ë‚˜ 'ë¯¸ê°€ì…', '-' ë“±ìœ¼ë¡œ í‘œê¸°ëœ ê²½ìš° 0ìœ¼ë¡œ ì²˜ë¦¬í•´.
3. **[ì¤‘ìš”]** ë‡Œì§ˆí™˜/ì‹¬ì¥ì§ˆí™˜ì˜ ê²½ìš°, ë‹¨ìˆœíˆ 'ì§„ë‹¨ë¹„'ë¡œ í‰ì¹˜ì§€ ë§ê³ , **'ë‡Œì¶œí˜ˆ vs ë‡Œì¡¸ì¤‘ vs ë‡Œí˜ˆê´€'** ì¤‘ ì–´ë””ì— í•´ë‹¹í•˜ëŠ”ì§€ ì •í™•íˆ êµ¬ë¶„í•´ì„œ ë„£ì–´. (ì´ê²Œ ë¦¬ëª¨ë¸ë§ì˜ í•µì‹¬ ê·¼ê±°ì„)
4. **[ì¤‘ìš”]** í˜„ì¬ ê°€ì…í•œ ëª¨ë“  ë³´í—˜ì˜ ëª©ë¡ì„ ì¶”ì¶œí•˜ì—¬ insurance_listì— í¬í•¨í•´. ê° ë³´í—˜ì˜ ë‚©ì…ê¸°ê°„, ë³´í—˜ê¸°ê°„, ì›”ë³´í—˜ë£Œ, ë³´í—˜ ì„¤ëª…ì„ ì •í™•íˆ ì¶”ì¶œí•´.
5. **[ì¤‘ìš”]** customer_profileì˜ premium_ratioëŠ” (total_monthly_premium / monthly_income * 100)ë¡œ ê³„ì‚°í•˜ê³ , premium_statusëŠ” í‰ê·  8~12% ê¸°ì¤€ìœ¼ë¡œ "ë¶€ì¡±" (8% ë¯¸ë§Œ), "ì ì •" (8~12%), "ê³¼ë‹¤" (12% ì´ˆê³¼)ë¡œ íŒë‹¨í•´.

ë°˜ë“œì‹œ JSON í˜•ì‹ë§Œ ì¶œë ¥í•˜ê³ , ë‹¤ë¥¸ ì„¤ëª…ì€ í¬í•¨í•˜ì§€ ë§ˆ.

# ì¶”ê°€ ê³ ê° ì •ë³´ (PDF ë¶„ì„ ì‹œ ì°¸ê³ )
""" + (f"""
ê³ ê°ëª…: {customer_info.get('name', '') if customer_info else ''}
ì„±ë³„: {customer_info.get('gender', '') if customer_info else ''}
ë‚˜ì´: {customer_info.get('age', 0) if customer_info else 0}ì„¸
ì›”ìˆ˜ì…: {customer_info.get('monthly_income', 0) if customer_info else 0}ë§Œì›

**[ì¤‘ìš”]** customer_profileì˜ monthly_income í•„ë“œì— ìœ„ ì›”ìˆ˜ì… ê°’ì„ ë°˜ë“œì‹œ í¬í•¨ì‹œì¼œì•¼ í•©ë‹ˆë‹¤.
**[ì¤‘ìš”]** premium_ratioëŠ” (total_monthly_premium / (monthly_income * 10000) * 100)ë¡œ ê³„ì‚°í•©ë‹ˆë‹¤.
**[ì¤‘ìš”]** premium_statusëŠ” í‰ê·  8~12% ê¸°ì¤€ìœ¼ë¡œ íŒë‹¨í•©ë‹ˆë‹¤:
- premium_ratio < 8%: "ë¶€ì¡±"
- 8% <= premium_ratio <= 12%: "ì ì •"  
- premium_ratio > 12%: "ê³¼ë‹¤"

""" if customer_info else "") + """
ê³ ê° ë³´ì¥ë¶„ì„ ë¦¬í¬íŠ¸ í…ìŠ¤íŠ¸:
""" + text[:100000]  # í• ë‹¹ëŸ‰ ì ˆì•½ì„ ìœ„í•´ í…ìŠ¤íŠ¸ ê¸¸ì´ ì œí•œ (10ë§Œì)
    
    try:
        # ì¬ì‹œë„ ë¡œì§ (í• ë‹¹ëŸ‰ ì´ˆê³¼ ì‹œ)
        max_retries = 3
        retry_delay = 5  # ì´ˆê¸° ëŒ€ê¸° ì‹œê°„ (ì´ˆ)
        
        for attempt in range(max_retries):
            try:
                response = model.generate_content(prompt)
                result_text = response.text
                return _parse_json_with_retry(result_text)
            except Exception as e:
                error_str = str(e)
                # í• ë‹¹ëŸ‰ ì´ˆê³¼ ì˜¤ë¥˜ì¸ ê²½ìš° ì¬ì‹œë„
                if ("429" in error_str or "quota" in error_str.lower() or "rate" in error_str.lower()) and attempt < max_retries - 1:
                    # ì¬ì‹œë„ ëŒ€ê¸° ì‹œê°„ ì¶”ì¶œ ë˜ëŠ” ê¸°ë³¸ê°’ ì‚¬ìš©
                    wait_time = retry_delay * (attempt + 1)  # ì§€ìˆ˜ ë°±ì˜¤í”„
                    st.warning(f"âš ï¸ í• ë‹¹ëŸ‰ ì´ˆê³¼. {wait_time}ì´ˆ í›„ ì¬ì‹œë„í•©ë‹ˆë‹¤... (ì‹œë„ {attempt + 1}/{max_retries})")
                    time.sleep(wait_time)
                    continue
                else:
                    # ë‹¤ë¥¸ ì˜¤ë¥˜ì´ê±°ë‚˜ ìµœëŒ€ ì¬ì‹œë„ íšŸìˆ˜ ì´ˆê³¼
                    raise e
    except Exception as e:
        error_str = str(e)
        if "429" in error_str or "quota" in error_str.lower():
            st.error("âš ï¸ ê³ ê° ë³´í—˜ ë¶„ì„ ì˜¤ë¥˜: í• ë‹¹ëŸ‰ ì´ˆê³¼")
            st.info("ğŸ’¡ ì ì‹œ í›„ ë‹¤ì‹œ ì‹œë„í•˜ê±°ë‚˜, ë” ì‘ì€ í…ìŠ¤íŠ¸ë¡œ ë¶„ì„í•´ë³´ì„¸ìš”.\nì‚¬ìš©ëŸ‰ í™•ì¸: https://ai.dev/usage")
        else:
            st.error(f"ê³ ê° ë³´í—˜ ë¶„ì„ ì˜¤ë¥˜: {str(e)}")
        return {}

def _generate_final_recommendation(customer_analysis: Dict, comparison_results: List[Dict], customer_profile: Dict) -> Dict:
    """ëª¨ë“  ë¹„êµ ê²°ê³¼ë¥¼ ì¢…í•©í•˜ì—¬ ìµœì¢… ì¶”ì²œ ìƒì„±"""
    if not comparison_results:
        return {}
    
    model = init_gemini()
    if not model:
        return {}
    
    # ìµœê³  ì ìˆ˜ ìƒí’ˆ ì°¾ê¸°
    best_product = comparison_results[0] if comparison_results else None
    
    prompt = f"""# Role Definition

ë„ˆëŠ” ëŒ€í•œë¯¼êµ­ ìµœê³ ì˜ 'ë³´í—˜ ì¬ë¬´ ì„¤ê³„ì‚¬'ì´ì 'ë³´í—˜ ì»¨ì„¤í„´íŠ¸'ì•¼.

ê³ ê°ì˜ í˜„ì¬ ë³´í—˜ê³¼ ì—¬ëŸ¬ ì‹ ê·œ ìƒí’ˆë“¤ì„ ë¹„êµ ë¶„ì„í•œ ê²°ê³¼ë¥¼ ì¢…í•©í•˜ì—¬, **ìµœì¢… ê²°ë¡ ê³¼ ì¶”ì²œ**ì„ ì‘ì„±í•´ì¤˜.

# Input Data

1. **ê³ ê° í”„ë¡œí•„**:
- ë‚˜ì´: {customer_profile.get('age', 0)}ì„¸
- ì„±ë³„: {customer_profile.get('gender', '')}
- ì›”ìˆ˜ì…: {customer_profile.get('monthly_income', 0)}ë§Œì›

2. **í˜„ì¬ ë³´í—˜ (AS-IS)**:
{json.dumps(customer_analysis, ensure_ascii=False, indent=2)}

3. **ë¹„êµ ë¶„ì„ ê²°ê³¼ (ìƒìœ„ 3ê°œ ìƒí’ˆ)**:
{json.dumps(comparison_results[:3], ensure_ascii=False, indent=2)}

# Task Goal

**í˜„ì¬ ë³´í—˜ì„ ìœ ì§€í•´ì•¼ í• ì§€, ì•„ë‹ˆë©´ ì‹ ê·œ ìƒí’ˆìœ¼ë¡œ ì „í™˜í•´ì•¼ í• ì§€** ëª…í™•í•œ ê²°ë¡ ì„ ë‚´ë ¤ì¤˜.

# Analysis Guidelines

1. **í˜„ì¬ ë³´í—˜ vs ì‹ ê·œ ìƒí’ˆ ì¢…í•© ë¹„êµ**:
   - ë³´ì¥ ë²”ìœ„, ë³´í—˜ë£Œ, ì¬ì • ì í•©ì„±, ìƒì•  ì£¼ê¸° ì í•©ì„±ì„ ì¢…í•©ì ìœ¼ë¡œ ë¹„êµ
   - í˜„ì¬ ë³´í—˜ì´ ë” ë‚˜ì€ ì ê³¼ ì‹ ê·œ ìƒí’ˆì´ ë” ë‚˜ì€ ì ì„ ëª…í™•íˆ êµ¬ë¶„

2. **ì „í™˜ í•„ìš”ì„± íŒë‹¨**:
   - í˜„ì¬ ë³´í—˜ ìœ ì§€ê°€ ë‚˜ì€ ê²½ìš°: ì´ìœ ì™€ ê·¼ê±° ì œì‹œ
   - ì‹ ê·œ ìƒí’ˆ ì „í™˜ì´ ë‚˜ì€ ê²½ìš°: ì–´ë–¤ ìƒí’ˆìœ¼ë¡œ ì „í™˜í• ì§€, ì „í™˜ ì‹œ ì˜ˆìƒ ì´ì  ì œì‹œ
   - ì¶”ê°€ ê°€ì…ì´ ë‚˜ì€ ê²½ìš°: ì–´ë–¤ ìƒí’ˆì„ ì¶”ê°€í• ì§€ ì œì‹œ

3. **ìµœì¢… ì¶”ì²œ**:
   - ëª…í™•í•œ ê²°ë¡  (í˜„ì¬ ìœ ì§€ / ì‹ ê·œ ì „í™˜ / ì¶”ê°€ ê°€ì…)
   - êµ¬ì²´ì ì¸ ì‹¤í–‰ ë°©ì•ˆ
   - ê³ ê°ì„ ì„¤ë“í•  ìˆ˜ ìˆëŠ” ê·¼ê±°

# Output Format (JSON Structure)

ë°˜ë“œì‹œ ì•„ë˜ JSON í¬ë§·ìœ¼ë¡œ ì¶œë ¥í•´.

{{
  "final_verdict": "í˜„ì¬ ë³´í—˜ ìœ ì§€ / ì‹ ê·œ ìƒí’ˆ ì „í™˜ / í˜„ì¬ ë³´í—˜ ìœ ì§€ + ì‹ ê·œ ì¶”ê°€ ê°€ì…",
  "recommended_product": {{
    "product_name": "ì¶”ì²œ ìƒí’ˆëª… (ì „í™˜/ì¶”ê°€ ì‹œ)",
    "company": "ë³´í—˜ì‚¬ëª…",
    "priority_score": 0
  }},
  "current_vs_new_comparison": {{
    "current_advantages": ["í˜„ì¬ ë³´í—˜ì´ ë” ë‚˜ì€ ì ë“¤"],
    "new_advantages": ["ì‹ ê·œ ìƒí’ˆì´ ë” ë‚˜ì€ ì ë“¤"],
    "overall_winner": "í˜„ì¬ / ì‹ ê·œ"
  }},
  "recommendation_details": {{
    "should_switch": true/false,
    "switch_reason": "ì „í™˜í•´ì•¼ í•˜ëŠ” ì´ìœ  ë˜ëŠ” ìœ ì§€í•´ì•¼ í•˜ëŠ” ì´ìœ ",
    "expected_benefit": "ì „í™˜/ì¶”ê°€ ì‹œ ì˜ˆìƒ ì´ì  (ë³´ì¥ í–¥ìƒ, ë³´í—˜ë£Œ ì ˆê° ë“±)",
    "expected_premium_change": "ë³´í—˜ë£Œ ë³€í™” (ì¦ê°€/ê°ì†Œ/ìœ ì§€)",
    "action_plan": "êµ¬ì²´ì ì¸ ì‹¤í–‰ ë°©ì•ˆ",
    "closing_ment": "ê³ ê°ì„ ì„¤ë“í•˜ëŠ” ë§ˆë¬´ë¦¬ ë©˜íŠ¸ (êµ¬ì²´ì ì´ê³  ê°ì„±ì )"
  }}
}}

ë°˜ë“œì‹œ JSON í˜•ì‹ë§Œ ì¶œë ¥í•˜ê³ , ë‹¤ë¥¸ ì„¤ëª…ì€ í¬í•¨í•˜ì§€ ë§ˆ.
"""
    
    try:
        response = model.generate_content(prompt)
        result_text = response.text
        return _parse_json_with_retry(result_text)
    except Exception as e:
        st.error(f"ìµœì¢… ì¶”ì²œ ìƒì„± ì˜¤ë¥˜: {str(e)}")
        return {}

def compare_products(customer_data: Dict, product_data: Dict, customer_profile: Dict = None) -> Dict:
    """ê³ ê° ë°ì´í„°ì™€ ìƒí’ˆ ë°ì´í„° ë¹„êµ ë¶„ì„ (ì¬ë¬´ ì„¤ê³„ í¬í•¨)"""
    model = init_gemini()
    if not model:
        return {}
    
    # ê³ ê° í”„ë¡œí•„ ì •ë³´ ì¤€ë¹„
    profile_info = ""
    if customer_profile:
        profile_info = f"""
ê³ ê° í”„ë¡œí•„:
- ë‚˜ì´: {customer_profile.get('age', 0)}ì„¸
- ì„±ë³„: {customer_profile.get('gender', '')}
- ì›”ìˆ˜ì…: {customer_profile.get('monthly_income', 0)}ë§Œì›
"""
    
    prompt = f"""# Role Definition

ë„ˆëŠ” ëŒ€í•œë¯¼êµ­ ìµœê³ ì˜ 'ë³´í—˜ ì¬ë¬´ ì„¤ê³„ì‚¬'ì´ì 'ì†í•´ì‚¬ì •ì‚¬'ì•¼.

ê³ ê°ì˜ [ì¸ì  ì‚¬í•­/ì†Œë“ ìˆ˜ì¤€]ê³¼ [í˜„ì¬ ê°€ì… ë³´í—˜]ì„ ë¶„ì„í•˜ê³ , ìš°ë¦¬ê°€ ì œì•ˆí•˜ëŠ” [ì¶”ì²œ ë³´í—˜]ê³¼ ë¹„êµí•˜ì—¬ **ìµœì ì˜ ë¦¬ëª¨ë¸ë§ ì œì•ˆì„œ**ë¥¼ ì‘ì„±í•´ì¤˜.

# Input Data

1. **ê³ ê° í”„ë¡œí•„**:{profile_info}

2. **í˜„ì¬ ê°€ì… ë³´í—˜ (AS-IS)**:
{json.dumps(customer_data, ensure_ascii=False, indent=2)}

3. **ì¶”ì²œ ëŒ€ìƒ ë³´í—˜ (TO-BE)**:
{json.dumps(product_data, ensure_ascii=False, indent=2)}

# Analysis Guidelines (ë¶„ì„ ì§€ì¹¨)

## 1. ì¬ì • ì í•©ì„± ë¶„ì„ (Financial Analysis)

- ê³ ê°ì˜ ì›”ìˆ˜ì… ëŒ€ë¹„ ì ì • ë³´í—˜ë£Œ(ë³´í†µ 8~12% ë‚´ì™¸)ë¥¼ ì‚°ì¶œí•´.
- í˜„ì¬ ë‚©ì… ë³´í—˜ë£Œê°€ ì ì •í•œì§€, ì•„ë‹ˆë©´ ë„ˆë¬´ ì ì–´ì„œ(ë³´ì¥ ê³µë°±) í˜¹ì€ ë„ˆë¬´ ë§ì•„ì„œ(ê³¼ì†Œë¹„) ë¬¸ì œì¸ì§€ íŒë‹¨í•´.
- ì¶”ì²œ ìƒí’ˆì˜ ì˜ˆìƒ ë³´í—˜ë£Œê°€ ê³ ê°ì˜ ì¬ì • ìƒíƒœì— ì í•©í•œì§€ í‰ê°€í•´.

## 2. ìƒì•  ì£¼ê¸°ë³„ ë³´ì¥ ë¶„ì„ (Lifecycle Gap)

- ê³ ê°ì˜ ë‚˜ì´ì™€ ì„±ë³„ì„ ê³ ë ¤í•  ë•Œ ë°˜ë“œì‹œ í•„ìš”í•œ 'í•„ìˆ˜ ë³´ì¥'ì´ ë¬´ì—‡ì¸ì§€ ì •ì˜í•´. (ì˜ˆ: 40ëŒ€ ê°€ì¥ì€ ì‚¬ë§/3ëŒ€ì§ˆë³‘ í•„ìˆ˜, 30ëŒ€ ì—¬ì„±ì€ ì•”/ìë…€êµìœ¡ë¹„ ë“±)
- í˜„ì¬ ë³´í—˜ì—ì„œ ê·¸ ë¶€ë¶„ì´ ì–¼ë§ˆë‚˜ ì¶©ì¡±ë˜ê³  ìˆëŠ”ì§€(ê³¼ë¶€ì¡±) í‰ê°€í•´.
- ë‚˜ì´ëŒ€ë³„ ìœ„í—˜ë„ì™€ ë³´ì¥ ìš°ì„ ìˆœìœ„ë¥¼ ê³ ë ¤í•œ ë¶„ì„ì„ ìˆ˜í–‰í•´.

## 3. ì •ë°€ ë¹„êµ ë¶„ì„ (AS-IS vs TO-BE)

- **ë³´ì¥ ë²”ìœ„(Scope):** ë‡Œì¶œí˜ˆ vs ë‡Œì¡¸ì¤‘ vs ë‡Œí˜ˆê´€, ê¸‰ì„±ì‹¬ê·¼ê²½ìƒ‰ vs í—ˆí˜ˆì„± ë“± 'ë²”ìœ„'ì˜ ì°¨ì´ë¥¼ ì •í™•íˆ ë¹„êµí•´.
- **ê°€ì… ê¸ˆì•¡(Amount):** í˜„ì¬ ë³´ì¥ ê¸ˆì•¡ì´ ì‹¤ì œ ì¹˜ë£Œë¹„ë¡œ ì¶©ë¶„í•œì§€ ë¹„êµí•´.
- **ì•½ê´€ ë…ì†Œì¡°í•­:** ê¸°ì¡´ ë³´í—˜ì— ë‚˜ìœ ì¡°ê±´(ê°±ì‹  í­íƒ„, ë©´ì±…ê¸°ê°„ ë“±)ì´ ìˆë‹¤ë©´ ì§€ì í•˜ê³ , ì¶”ì²œ ìƒí’ˆì´ ê·¸ê±¸ ì–´ë–»ê²Œ í•´ê²°í•˜ëŠ”ì§€ ì„¤ëª…í•´.

# Output Format (JSON Structure)

ë°˜ë“œì‹œ ì•„ë˜ JSON í¬ë§·ìœ¼ë¡œ ì¶œë ¥í•´.

{{
  "financial_diagnosis": {{
    "status": "ë¶€ì¡± / ì ì • / ê³¼ë‹¤",
    "score": 0,
    "current_premium_ratio": 0,
    "recommended_premium_ratio": 0,
    "comment": "ì›” ì†Œë“ ëŒ€ë¹„ í˜„ì¬ ë³´í—˜ë£Œì™€ ì¶”ì²œ ë³´í—˜ë£Œì˜ ì ì •ì„± í‰ê°€"
  }},
  "lifecycle_analysis": {{
    "age_group": "30ëŒ€/40ëŒ€/50ëŒ€ ë“±",
    "required_coverage": ["í•„ìˆ˜ ë³´ì¥ 1", "í•„ìˆ˜ ë³´ì¥ 2", ...],
    "current_gap": "í˜„ì¬ ë³´ì¥ì—ì„œ ë¶€ì¡±í•œ í•„ìˆ˜ ë³´ì¥ ì„¤ëª…",
    "priority_recommendation": "ë‚˜ì´/ì„±ë³„ì— ë”°ë¥¸ ìš°ì„ ìˆœìœ„ ì¶”ì²œ"
  }},
  "coverage_comparison": [
    {{
      "category": "ì•” ë³´ì¥",
      "asis_text": "í˜„ì¬ ë³´ì¥ ë‚´ìš© (ì˜ˆ: 1,000ë§Œì›, ì†Œì•¡ì•” ì œì™¸)",
      "tobe_text": "ì¶”ì²œ ë³´ì¥ ë‚´ìš© (ì˜ˆ: 5,000ë§Œì›, í‘œì í•­ì•” í¬í•¨)",
      "verdict": "AS-IS ìœ ë¦¬ / TO-BE ìŠ¹ë¦¬ / ë™ë“±",
      "reason": "ë¹„êµ ê·¼ê±° ë° íŒë‹¨ ì´ìœ "
    }},
    {{
      "category": "ë‡Œ/ì‹¬ì¥ ë³´ì¥",
      "asis_text": "í˜„ì¬ ë³´ì¥ ë²”ìœ„",
      "tobe_text": "ì¶”ì²œ ë³´ì¥ ë²”ìœ„",
      "verdict": "AS-IS ìœ ë¦¬ / TO-BE ìŠ¹ë¦¬ / ë™ë“±",
      "reason": "ë³´ì¥ ë²”ìœ„ ì°¨ì´ ë° ì‹¤ì œ ë³´ì¥ë¥  ë¹„êµ"
    }}
  ],
  "final_recommendation": {{
    "strategy": "í˜„ì¬ ë³´í—˜ ìœ ì§€ OR í˜„ì¬ ë³´í—˜ í•´ì§€ í›„ ì‹ ê·œ ìƒí’ˆ ì „í™˜ OR í˜„ì¬ ë³´í—˜ ìœ ì§€ + ì‹ ê·œ ì¶”ê°€ ê°€ì…",
    "should_switch": true/false,
    "switch_reason": "ì „í™˜í•´ì•¼ í•˜ëŠ” ì´ìœ  ë˜ëŠ” ìœ ì§€í•´ì•¼ í•˜ëŠ” ì´ìœ ",
    "expected_benefit": "ì „í™˜ ì‹œ ì˜ˆìƒ ì´ì  (ë³´ì¥ í–¥ìƒ, ë³´í—˜ë£Œ ì ˆê° ë“±)",
    "expected_premium": "ì˜ˆìƒ ë³´í—˜ë£Œ (ë§Œì› ë‹¨ìœ„)",
    "reasoning": "ì¬ì • ìƒíƒœì™€ ë³´ì¥ í•„ìš”ì„±ì„ ì¢…í•©ì ìœ¼ë¡œ ê³ ë ¤í•œ ì „ëµ ì„¤ëª…",
    "closing_ment": "ê³ ê°ì„ ì„¤ë“í•˜ëŠ” ë§ˆë¬´ë¦¬ ë©˜íŠ¸ (êµ¬ì²´ì ì´ê³  ê°ì„±ì )"
  }},
  "priority_score": 85,
  "comparison_summary": {{
    "current_better": ["í˜„ì¬ ë³´í—˜ì´ ë” ë‚˜ì€ í•­ëª©ë“¤"],
    "new_better": ["ì‹ ê·œ ìƒí’ˆì´ ë” ë‚˜ì€ í•­ëª©ë“¤"],
    "overall_verdict": "í˜„ì¬ ìœ ì§€ / ì‹ ê·œ ì „í™˜ / ì¶”ê°€ ê°€ì…"
  }}
}}

ë°˜ë“œì‹œ JSON í˜•ì‹ë§Œ ì¶œë ¥í•˜ê³ , ë‹¤ë¥¸ ì„¤ëª…ì€ í¬í•¨í•˜ì§€ ë§ˆ.
"""
    
    try:
        # ì¬ì‹œë„ ë¡œì§ (í• ë‹¹ëŸ‰ ì´ˆê³¼ ì‹œ)
        max_retries = 3
        retry_delay = 5  # ì´ˆê¸° ëŒ€ê¸° ì‹œê°„ (ì´ˆ)
        
        for attempt in range(max_retries):
            try:
                response = model.generate_content(prompt)
                result_text = response.text
                return _parse_json_with_retry(result_text)
            except Exception as e:
                error_str = str(e)
                # í• ë‹¹ëŸ‰ ì´ˆê³¼ ì˜¤ë¥˜ì¸ ê²½ìš° ì¬ì‹œë„
                if ("429" in error_str or "quota" in error_str.lower() or "rate" in error_str.lower()) and attempt < max_retries - 1:
                    # ì¬ì‹œë„ ëŒ€ê¸° ì‹œê°„ ì¶”ì¶œ ë˜ëŠ” ê¸°ë³¸ê°’ ì‚¬ìš©
                    wait_time = retry_delay * (attempt + 1)  # ì§€ìˆ˜ ë°±ì˜¤í”„
                    st.warning(f"âš ï¸ í• ë‹¹ëŸ‰ ì´ˆê³¼. {wait_time}ì´ˆ í›„ ì¬ì‹œë„í•©ë‹ˆë‹¤... (ì‹œë„ {attempt + 1}/{max_retries})")
                    time.sleep(wait_time)
                    continue
                else:
                    # ë‹¤ë¥¸ ì˜¤ë¥˜ì´ê±°ë‚˜ ìµœëŒ€ ì¬ì‹œë„ íšŸìˆ˜ ì´ˆê³¼
                    raise e
    except Exception as e:
        error_str = str(e)
        if "429" in error_str or "quota" in error_str.lower():
            st.error("âš ï¸ ë¹„êµ ë¶„ì„ ì˜¤ë¥˜: í• ë‹¹ëŸ‰ ì´ˆê³¼")
            st.info("ğŸ’¡ ì ì‹œ í›„ ë‹¤ì‹œ ì‹œë„í•˜ê±°ë‚˜, ë” ì‘ì€ í…ìŠ¤íŠ¸ë¡œ ë¶„ì„í•´ë³´ì„¸ìš”.\nì‚¬ìš©ëŸ‰ í™•ì¸: https://ai.dev/usage")
        else:
            st.error(f"ë¹„êµ ë¶„ì„ ì˜¤ë¥˜: {str(e)}")
        return {}

# ì‚¬ì´ë“œë°” ë„¤ë¹„ê²Œì´ì…˜
st.sidebar.title("ğŸ“Š AI ë³´í—˜ ë¶„ì„ í”Œë«í¼")
mode = st.sidebar.radio("ëª¨ë“œ ì„ íƒ", ["ê´€ë¦¬ì ëª¨ë“œ (Admin)", "ì„¤ê³„ì‚¬ ëª¨ë“œ (Agent)"])

# ê´€ë¦¬ì ëª¨ë“œ
if mode == "ê´€ë¦¬ì ëª¨ë“œ (Admin)":
    st.title("ğŸ‘¨â€ğŸ’¼ ê´€ë¦¬ì ëª¨ë“œ")
    st.markdown("---")
    
    tab1, tab2, tab3 = st.tabs(["ğŸ“„ ì‹ ê·œ ì•½ê´€ ë“±ë¡", "ğŸ“¦ ë“±ë¡ëœ ìƒí’ˆ ê´€ë¦¬", "ğŸ“‹ ìƒë‹´ ì´ë ¥ ì¡°íšŒ"])
    
    # Tab 1: ì‹ ê·œ ì•½ê´€ ë“±ë¡
    with tab1:
        st.subheader("ğŸ“„ ì‹ ê·œ ì•½ê´€ ë“±ë¡")
        
        # ì„¸ì…˜ ìƒíƒœ ì´ˆê¸°í™” (í•„ìš”í•œ ê²½ìš°)
        if 'admin_analysis_result' not in st.session_state:
            st.session_state['admin_analysis_result'] = None
        if 'admin_extracted_text' not in st.session_state:
            st.session_state['admin_extracted_text'] = None
        if 'admin_file_name' not in st.session_state:
            st.session_state['admin_file_name'] = None
        if 'admin_is_analyzing' not in st.session_state:
            st.session_state['admin_is_analyzing'] = False
        if 'admin_analysis_complete' not in st.session_state:
            st.session_state['admin_analysis_complete'] = False
        
        uploaded_file = st.file_uploader("ë³´í—˜ ì•½ê´€ PDF íŒŒì¼ ì—…ë¡œë“œ", type=["pdf"], key="admin_pdf_uploader")
        
        # íŒŒì¼ì´ ìƒˆë¡œ ì—…ë¡œë“œëœ ê²½ìš° (ì´ì „ íŒŒì¼ê³¼ ë‹¤ë¥¸ ê²½ìš°ì—ë§Œ ì¶”ì¶œ)
        if uploaded_file is not None:
            current_file_name = uploaded_file.name
            saved_file_name = st.session_state.get('admin_file_name')
            
            # ìƒˆ íŒŒì¼ì´ê±°ë‚˜ ì•„ì§ ì¶”ì¶œí•˜ì§€ ì•Šì€ ê²½ìš°ì—ë§Œ í…ìŠ¤íŠ¸ ì¶”ì¶œ
            if current_file_name != saved_file_name or st.session_state.get('admin_extracted_text') is None:
                # íŒŒì¼ì„ ë°”ì´íŠ¸ë¡œ ì½ê¸°
                pdf_bytes = uploaded_file.read()
                text = extract_text_from_pdf(pdf_bytes, uploaded_file.name)
                
                # ì„¸ì…˜ ìƒíƒœì— ì €ì¥
                st.session_state['admin_extracted_text'] = text
                st.session_state['admin_file_name'] = uploaded_file.name
                # ìƒˆ íŒŒì¼ì´ ì—…ë¡œë“œë˜ë©´ ì´ì „ ë¶„ì„ ê²°ê³¼ ì´ˆê¸°í™”
                st.session_state['admin_analysis_result'] = None
                st.session_state['admin_analysis_complete'] = False
                st.session_state['admin_is_analyzing'] = False
        
        # ì„¸ì…˜ ìƒíƒœì—ì„œ í…ìŠ¤íŠ¸ ê°€ì ¸ì˜¤ê¸°
        text = st.session_state.get('admin_extracted_text')
        file_name = st.session_state.get('admin_file_name')
        
        if text:
            st.success(f"âœ… í…ìŠ¤íŠ¸ ì¶”ì¶œ ì™„ë£Œ ({len(text):,}ì)" + (f" - íŒŒì¼: {file_name}" if file_name else ""))
            
            st.subheader("ğŸ“ ì¶”ì¶œëœ í…ìŠ¤íŠ¸ ë¯¸ë¦¬ë³´ê¸°")
            st.text_area("í…ìŠ¤íŠ¸", text[:2000], height=200, disabled=True, key="preview_text")
            
            # ë¶„ì„ ê²°ê³¼ê°€ ì„¸ì…˜ ìƒíƒœì— ìˆëŠ”ì§€ í™•ì¸
            analysis_result = st.session_state.get('admin_analysis_result')
            is_analyzing = st.session_state.get('admin_is_analyzing', False)
            
            # ë¶„ì„ ê²°ê³¼ê°€ ìœ íš¨í•œì§€ í™•ì¸ (Noneì´ ì•„ë‹ˆê³  ë”•ì…”ë„ˆë¦¬ì´ë©° ë¹„ì–´ìˆì§€ ì•Šì•„ì•¼ í•¨)
            has_valid_result = (
                analysis_result is not None and 
                isinstance(analysis_result, dict) and 
                len(analysis_result) > 0
            )
            
            # ë””ë²„ê¹… ì •ë³´ (ê°œë°œ ì¤‘ì—ë§Œ í‘œì‹œ)
            with st.expander("ğŸ” ë””ë²„ê¹… ì •ë³´ (ë¶„ì„ ìƒíƒœ)", expanded=False):
                st.write(f"- text ì¡´ì¬: {text is not None and len(text) > 0}")
                st.write(f"- text ê¸¸ì´: {len(text) if text else 0}")
                st.write(f"- analysis_result íƒ€ì…: {type(analysis_result)}")
                st.write(f"- analysis_result ê°’: {analysis_result}")
                st.write(f"- has_valid_result: {has_valid_result}")
                st.write(f"- is_analyzing: {is_analyzing}")
                st.write(f"- admin_is_analyzing: {st.session_state.get('admin_is_analyzing', False)}")
                st.write(f"- ë²„íŠ¼ í‘œì‹œ ì¡°ê±´1 (not has_valid_result): {not has_valid_result}")
                st.write(f"- ë²„íŠ¼ í‘œì‹œ ì¡°ê±´2 (not is_analyzing): {not is_analyzing}")
                st.write(f"- ë²„íŠ¼ í‘œì‹œ ê°€ëŠ¥: {not has_valid_result and not is_analyzing}")
            
            # ë¶„ì„ ì‹œì‘ ë²„íŠ¼ (ìœ íš¨í•œ ë¶„ì„ ê²°ê³¼ê°€ ì—†ê³  ë¶„ì„ ì¤‘ì´ ì•„ë‹ ë•Œë§Œ í‘œì‹œ)
            if is_analyzing:
                st.info("ğŸ”„ ë¶„ì„ì´ ì§„í–‰ ì¤‘ì…ë‹ˆë‹¤...")
            elif not has_valid_result:
                # ë²„íŠ¼ì„ ëª…í™•í•˜ê²Œ í‘œì‹œ
                st.markdown("---")
                st.markdown("### ğŸ¤– AI ë¶„ì„")
                analyze_button = st.button("AI ë¶„ì„ ì‹œì‘", key="admin_analyze_button", type="primary", use_container_width=True)
                if analyze_button:
                    # ë¶„ì„ ì‹œì‘ í”Œë˜ê·¸ ì„¤ì •
                    st.session_state['admin_is_analyzing'] = True
                    st.rerun()
                st.markdown("---")
            
            # ë¶„ì„ ì§„í–‰ ì¤‘ì¼ ë•Œ
            if is_analyzing and not has_valid_result:
                with st.spinner("ğŸ”„ AI ë¶„ì„ ì¤‘... (ì‹œê°„ì´ ê±¸ë¦´ ìˆ˜ ìˆìŠµë‹ˆë‹¤. ì ì‹œë§Œ ê¸°ë‹¤ë ¤ì£¼ì„¸ìš”)"):
                    try:
                        analysis_result = analyze_insurance_terms(text)
                        
                        # ë¶„ì„ ì™„ë£Œ í”Œë˜ê·¸ í•´ì œ
                        st.session_state['admin_is_analyzing'] = False
                        
                        if analysis_result and isinstance(analysis_result, dict) and len(analysis_result) > 0:
                            # ì„¸ì…˜ ìƒíƒœì— ì €ì¥
                            st.session_state['admin_analysis_result'] = analysis_result
                            st.session_state['admin_analysis_complete'] = True
                            st.success("âœ… ë¶„ì„ ì™„ë£Œ!")
                            st.rerun()
                        else:
                            st.error("âŒ ë¶„ì„ ê²°ê³¼ë¥¼ ë°›ì§€ ëª»í–ˆìŠµë‹ˆë‹¤.")
                            st.write(f"ë¶„ì„ ê²°ê³¼ íƒ€ì…: {type(analysis_result)}")
                            st.write(f"ë¶„ì„ ê²°ê³¼: {analysis_result}")
                            st.info("ğŸ’¡ ë¶„ì„ ê²°ê³¼ê°€ ë¹„ì–´ìˆê±°ë‚˜ ì˜¬ë°”ë¥´ì§€ ì•ŠìŠµë‹ˆë‹¤. PDF íŒŒì¼ì´ ì˜¬ë°”ë¥¸ì§€ í™•ì¸í•˜ê±°ë‚˜ ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.")
                    except Exception as e:
                        st.session_state['admin_is_analyzing'] = False
                        st.error(f"âŒ ë¶„ì„ ì¤‘ ì˜¤ë¥˜ ë°œìƒ: {str(e)}")
                        import traceback
                        with st.expander("ğŸ” ìƒì„¸ ì—ëŸ¬ ì •ë³´"):
                            st.code(traceback.format_exc())
            
            # ë¶„ì„ ê²°ê³¼ í‘œì‹œ (ì„¸ì…˜ ìƒíƒœì—ì„œ ë‹¤ì‹œ ê°€ì ¸ì˜¤ê¸°)
            analysis_result = st.session_state.get('admin_analysis_result')
            has_valid_result = (
                analysis_result is not None and 
                isinstance(analysis_result, dict) and 
                len(analysis_result) > 0
            )
            
            # ë¶„ì„ ì™„ë£Œ ë©”ì‹œì§€ í‘œì‹œ
            if st.session_state.get('admin_analysis_complete', False):
                st.success("âœ… ë¶„ì„ì´ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤!")
            
            # ë¶„ì„ ê²°ê³¼ê°€ ìˆìœ¼ë©´ í‘œì‹œ
            if has_valid_result:
                st.subheader("ğŸ“Š ë¶„ì„ ê²°ê³¼")
                st.json(analysis_result)
                
                # ìƒí’ˆëª… ì…ë ¥ (ìƒˆë¡œìš´ êµ¬ì¡°ì— ë§ê²Œ ìˆ˜ì •)
                meta_info = analysis_result.get("meta_info", {})
                product_name = st.text_input("ìƒí’ˆëª…", value=meta_info.get("product_name", analysis_result.get("product_name", "")), key="product_name_input")
                company = st.text_input("ë³´í—˜ì‚¬ëª…", value=meta_info.get("company", analysis_result.get("company", "")), key="company_input")
                
                col1, col2 = st.columns(2)
                with col1:
                    if st.button("ğŸ’¾ DBì— ìƒí’ˆ ë“±ë¡", key="save_product_button"):
                            if not product_name:
                                st.error("ìƒí’ˆëª…ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.")
                            elif not supabase:
                                st.error("Supabase ì—°ê²°ì´ í•„ìš”í•©ë‹ˆë‹¤.")
                            else:
                                try:
                                    # ì €ì¥í•  ë°ì´í„° ì¤€ë¹„
                                    data = {
                                        "product_name": product_name,
                                        "company": company if company else None,
                                        "analysis_data": analysis_result,
                                        "user_id": ADMIN_USER_ID
                                    }
                                    
                                    # ë””ë²„ê¹… ì •ë³´ í‘œì‹œ
                                    with st.expander("ğŸ” ì €ì¥ ì „ ë°ì´í„° í™•ì¸"):
                                        st.json(data)
                                        st.write(f"ë°ì´í„° íƒ€ì…: {type(data)}")
                                        st.write(f"analysis_data íƒ€ì…: {type(analysis_result)}")
                                    
                                    # Supabaseì— ì €ì¥
                                    st.write("ğŸ”„ ë°ì´í„°ë² ì´ìŠ¤ì— ì €ì¥ ì¤‘...")
                                    
                                    # ì‹¤ì œ INSERT ì‹¤í–‰
                                    try:
                                        result = supabase.table("insurance_products").insert(data).execute()
                                        
                                        # ê²°ê³¼ ìƒì„¸ í™•ì¸
                                        st.write("ğŸ“Š ì‘ë‹µ ìƒì„¸ ì •ë³´:")
                                        st.write(f"- result íƒ€ì…: {type(result)}")
                                        st.write(f"- hasattr(result, 'data'): {hasattr(result, 'data')}")
                                        
                                        if hasattr(result, 'data'):
                                            st.write(f"- result.data: {result.data}")
                                            st.write(f"- result.data íƒ€ì…: {type(result.data)}")
                                            st.write(f"- result.data ê¸¸ì´: {len(result.data) if result.data else 0}")
                                        
                                        # ì„±ê³µ í™•ì¸
                                        if hasattr(result, 'data') and result.data and len(result.data) > 0:
                                            inserted_id = result.data[0].get('id')
                                            st.success(f"âœ… ìƒí’ˆ '{product_name}'ì´(ê°€) ì„±ê³µì ìœ¼ë¡œ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤! (ID: {inserted_id})")
                                            st.json(result.data[0])
                                            
                                            # ì €ì¥ í™•ì¸ì„ ìœ„í•´ ì¦‰ì‹œ ì¡°íšŒ
                                            try:
                                                # ìƒˆë¡œìš´ í´ë¼ì´ì–¸íŠ¸ë¡œ ì¡°íšŒ (ìºì‹œ ë¬´ì‹œ)
                                                fresh_client = create_client(SUPABASE_URL, SUPABASE_KEY)
                                                check_result = fresh_client.table("insurance_products").select("*").eq("id", inserted_id).execute()
                                                if check_result.data and len(check_result.data) > 0:
                                                    st.success(f"âœ… ì €ì¥ í™•ì¸ ì™„ë£Œ! í…Œì´ë¸”ì— {len(check_result.data)}ê°œ ë ˆì½”ë“œê°€ ìˆìŠµë‹ˆë‹¤.")
                                                    st.json(check_result.data[0])
                                                else:
                                                    st.warning("âš ï¸ ì €ì¥ì€ ì™„ë£Œë˜ì—ˆì§€ë§Œ ì¡°íšŒ ì‹œ ë°ì´í„°ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.")
                                                    # ì „ì²´ ì¡°íšŒë¡œ í™•ì¸
                                                    all_result = fresh_client.table("insurance_products").select("*").execute()
                                                    st.write(f"ì „ì²´ ìƒí’ˆ ìˆ˜: {len(all_result.data) if all_result.data else 0}")
                                            except Exception as check_error:
                                                st.warning(f"âš ï¸ ì €ì¥ í™•ì¸ ì¤‘ ì˜¤ë¥˜: {str(check_error)}")
                                                import traceback
                                                with st.expander("ğŸ” ì €ì¥ í™•ì¸ ì˜¤ë¥˜ ìƒì„¸"):
                                                    st.code(traceback.format_exc())
                                            
                                            # ì €ì¥ í›„ ì¦‰ì‹œ í™•ì¸
                                            st.success("ğŸ’¡ ì €ì¥ ì™„ë£Œ! 'ë“±ë¡ëœ ìƒí’ˆ ê´€ë¦¬' íƒ­ìœ¼ë¡œ ì´ë™í•˜ì—¬ í™•ì¸í•˜ì„¸ìš”.")
                                            
                                            # ë¶„ì„ ê²°ê³¼ëŠ” ìœ ì§€í•˜ë˜, ì €ì¥ ì™„ë£Œ í‘œì‹œ
                                            st.session_state['admin_saved'] = True
                                            
                                            # ì„¸ì…˜ ìƒíƒœ ì´ˆê¸°í™”í•˜ì—¬ ìƒˆë¡œê³ ì¹¨
                                            if 'supabase_client' in st.session_state:
                                                del st.session_state['supabase_client']
                                            
                                            # í˜ì´ì§€ ìƒˆë¡œê³ ì¹¨í•˜ì—¬ ëª©ë¡ì— ë°˜ì˜
                                            st.balloons()  # ì„±ê³µ ì¶•í•˜ ì• ë‹ˆë©”ì´ì…˜
                                            time.sleep(0.5)  # 0.5ì´ˆ ëŒ€ê¸° í›„ ìƒˆë¡œê³ ì¹¨
                                            st.rerun()
                                        else:
                                            st.error("âŒ ì €ì¥ ì‹¤íŒ¨: ì‘ë‹µ ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.")
                                            st.write("ğŸ“Š ì „ì²´ ì‘ë‹µ ê°ì²´:")
                                            st.write(f"- result: {result}")
                                            st.write(f"- result ì†ì„±: {[attr for attr in dir(result) if not attr.startswith('_')]}")
                                            
                                            # result ê°ì²´ì˜ ëª¨ë“  ì†ì„± í™•ì¸
                                            if hasattr(result, '__dict__'):
                                                st.write(f"- result.__dict__: {result.__dict__}")
                                            
                                            st.write("ğŸ” ë””ë²„ê¹… ì •ë³´:")
                                            st.write(f"- Supabase ì—°ê²°: {supabase is not None}")
                                            st.write(f"- ë°ì´í„°: {data}")
                                            
                                    except Exception as insert_error:
                                        # INSERT ìì²´ê°€ ì‹¤íŒ¨í•œ ê²½ìš°
                                        error_str = str(insert_error)
                                        st.error(f"âŒ INSERT ì‹¤í–‰ ì‹¤íŒ¨: {error_str}")
                                        
                                        # ì—ëŸ¬ íƒ€ì…ë³„ ì•ˆë‚´
                                        if "permission" in error_str.lower() or "policy" in error_str.lower() or "row level security" in error_str.lower():
                                            st.error("ğŸ”’ RLS ì •ì±… ë¬¸ì œë¡œ ë³´ì…ë‹ˆë‹¤!")
                                            st.info("""
                                            ğŸ’¡ í•´ê²° ë°©ë²•:
                                            1. Supabase ëŒ€ì‹œë³´ë“œ â†’ Authentication â†’ Policies
                                            2. insurance_products í…Œì´ë¸” ì„ íƒ
                                            3. INSERT ì •ì±…ì´ 'anon' ì—­í• ì— ëŒ€í•´ í™œì„±í™”ë˜ì–´ ìˆëŠ”ì§€ í™•ì¸
                                            4. supabase_rls_policies.sql íŒŒì¼ì˜ SQLì„ ì‹¤í–‰í•˜ì„¸ìš”
                                            """)
                                        elif "relation" in error_str.lower() or "does not exist" in error_str.lower():
                                            st.error("ğŸ“‹ í…Œì´ë¸”ì´ ì¡´ì¬í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤!")
                                            st.info("ğŸ’¡ supabase_setup.sql íŒŒì¼ì„ ì‹¤í–‰í•˜ì—¬ í…Œì´ë¸”ì„ ìƒì„±í•˜ì„¸ìš”.")
                                        elif "column" in error_str.lower():
                                            st.error("ğŸ“Š ì»¬ëŸ¼ ë¬¸ì œê°€ ìˆìŠµë‹ˆë‹¤!")
                                            st.info("ğŸ’¡ í…Œì´ë¸” êµ¬ì¡°ë¥¼ í™•ì¸í•˜ì„¸ìš”.")
                                        
                                        # ìƒì„¸ ì—ëŸ¬ ì •ë³´ í‘œì‹œ
                                        import traceback
                                        with st.expander("ğŸ” ìƒì„¸ ì—ëŸ¬ ì •ë³´"):
                                            st.code(traceback.format_exc())
                                        
                                except Exception as e:
                                    error_msg = str(e)
                                    st.error(f"âŒ ì €ì¥ ì˜¤ë¥˜: {error_msg}")
                                    
                                    # ìƒì„¸ ì—ëŸ¬ ì •ë³´ í‘œì‹œ
                                    import traceback
                                    with st.expander("ğŸ” ìƒì„¸ ì—ëŸ¬ ì •ë³´"):
                                        st.code(traceback.format_exc())
                                    
                                    st.info("ğŸ’¡ í™•ì¸ì‚¬í•­:\n- Supabase ì—°ê²° ìƒíƒœë¥¼ í™•ì¸í•˜ì„¸ìš”.\n- ë°ì´í„°ë² ì´ìŠ¤ í…Œì´ë¸” êµ¬ì¡°ë¥¼ í™•ì¸í•˜ì„¸ìš”.\n- RLS(Row Level Security) ì •ì±…ì´ í™œì„±í™”ë˜ì–´ ìˆëŠ”ì§€ í™•ì¸í•˜ì„¸ìš”.")
                
                with col2:
                    # ë¶„ì„ ê²°ê³¼ ì´ˆê¸°í™” ë²„íŠ¼
                    if st.button("ğŸ”„ ë¶„ì„ ì´ˆê¸°í™”", key="reset_analysis_button", help="ë¶„ì„ ê²°ê³¼ë¥¼ ì´ˆê¸°í™”í•˜ê³  ìƒˆë¡œ ë¶„ì„í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤"):
                        st.session_state['admin_analysis_result'] = None
                        st.session_state['admin_extracted_text'] = None
                        st.session_state['admin_file_name'] = None
                        st.session_state['admin_saved'] = False
                        st.session_state['admin_analysis_complete'] = False
                        st.session_state['admin_is_analyzing'] = False
                        st.rerun()
                
                # ì €ì¥ ì™„ë£Œ ë©”ì‹œì§€ í‘œì‹œ
                if st.session_state.get('admin_saved', False):
                    st.success("âœ… ìƒí’ˆì´ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤! 'ë“±ë¡ëœ ìƒí’ˆ ê´€ë¦¬' íƒ­ì—ì„œ í™•ì¸í•˜ì„¸ìš”.")
    
    # Tab 2: ë“±ë¡ëœ ìƒí’ˆ ê´€ë¦¬
    with tab2:
        st.subheader("ğŸ“¦ ë“±ë¡ëœ ìƒí’ˆ ê´€ë¦¬")
        
        if not supabase:
            st.error("Supabase ì—°ê²°ì´ í•„ìš”í•©ë‹ˆë‹¤.")
        else:
            try:
                # ë””ë²„ê¹…: ì¡°íšŒ ì „ ìƒíƒœ í™•ì¸
                st.write("ğŸ”„ ìƒí’ˆ ëª©ë¡ ì¡°íšŒ ì¤‘...")
                
                # ìƒˆë¡œìš´ í´ë¼ì´ì–¸íŠ¸ë¡œ ì¡°íšŒ (ìºì‹œ ë¬´ì‹œ)
                fresh_client = create_client(SUPABASE_URL, SUPABASE_KEY)
                products = fresh_client.table("insurance_products").select("*").order("created_at", desc=True).execute()
                
                # ë””ë²„ê¹… ì •ë³´ í‘œì‹œ
                with st.expander("ğŸ” ì¡°íšŒ ë””ë²„ê¹… ì •ë³´"):
                    st.write(f"- products íƒ€ì…: {type(products)}")
                    st.write(f"- hasattr(products, 'data'): {hasattr(products, 'data')}")
                    if hasattr(products, 'data'):
                        st.write(f"- products.data: {products.data}")
                        st.write(f"- products.data íƒ€ì…: {type(products.data)}")
                        st.write(f"- products.data ê¸¸ì´: {len(products.data) if products.data else 0}")
                        if products.data:
                            st.write(f"- ì²« ë²ˆì§¸ ìƒí’ˆ: {products.data[0] if len(products.data) > 0 else 'N/A'}")
                
                if products.data and len(products.data) > 0:
                    # DataFrameìœ¼ë¡œ ì¡°íšŒ
                    df = pd.DataFrame(products.data)
                    st.subheader(f"ë“±ë¡ëœ ìƒí’ˆ ({len(df)}ê°œ)")
                    st.dataframe(df[['id', 'product_name', 'company', 'created_at']], use_container_width=True)
                    
                    # ìƒí’ˆ ì„ íƒ
                    product_options = {f"{p['product_name']} ({p['company']})": p['id'] for p in products.data}
                    selected_product_name = st.selectbox("ìƒí’ˆ ì„ íƒ", list(product_options.keys()), key="product_select")
                    selected_id = product_options[selected_product_name]
                    
                    selected_product = next(p for p in products.data if p['id'] == selected_id)
                    
                    col1, col2 = st.columns(2)
                    
                    with col1:
                        st.subheader("ìƒí’ˆ ì •ë³´")
                        st.write(f"**ìƒí’ˆëª…:** {selected_product['product_name']}")
                        st.write(f"**ë³´í—˜ì‚¬:** {selected_product.get('company', 'N/A')}")
                        st.write(f"**ë“±ë¡ì¼:** {selected_product['created_at']}")
                        
                        # ìˆ˜ì • í¼
                        with st.expander("âœï¸ ìƒí’ˆ ì •ë³´ ìˆ˜ì •"):
                            new_name = st.text_input("ìƒí’ˆëª…", value=selected_product['product_name'], key="edit_name")
                            new_company = st.text_input("ë³´í—˜ì‚¬ëª…", value=selected_product.get('company', ''), key="edit_company")
                            
                            if st.button("ìˆ˜ì • ì‚¬í•­ ì €ì¥", key="save_edit"):
                                try:
                                    update_data = {
                                        "product_name": new_name,
                                        "company": new_company
                                    }
                                    supabase.table("insurance_products").update(update_data).eq("id", selected_id).execute()
                                    st.success("âœ… ìˆ˜ì • ì™„ë£Œ!")
                                    st.rerun()
                                except Exception as e:
                                    st.error(f"ìˆ˜ì • ì˜¤ë¥˜: {str(e)}")
                        
                        # ì‚­ì œ ë²„íŠ¼
                        if st.button("ìƒí’ˆ ì‚­ì œ", type="secondary", key="delete_product"):
                            try:
                                supabase.table("insurance_products").delete().eq("id", selected_id).execute()
                                st.success("âœ… ì‚­ì œ ì™„ë£Œ!")
                                st.rerun()
                            except Exception as e:
                                st.error(f"ì‚­ì œ ì˜¤ë¥˜: {str(e)}")
                    
                    with col2:
                        st.subheader("ë¶„ì„ ë°ì´í„° (JSON)")
                        analysis_json = json.dumps(selected_product.get('analysis_data', {}), ensure_ascii=False, indent=2)
                        edited_json = st.text_area("JSON í¸ì§‘", analysis_json, height=400, key="json_edit")
                        
                        if st.button("ìˆ˜ì • ì‚¬í•­ ì €ì¥", key="save_json"):
                            try:
                                edited_data = json.loads(edited_json)
                                supabase.table("insurance_products").update({"analysis_data": edited_data}).eq("id", selected_id).execute()
                                st.success("âœ… JSON ì €ì¥ ì™„ë£Œ!")
                                st.rerun()
                            except json.JSONDecodeError as e:
                                st.error(f"âŒ ìœ íš¨í•˜ì§€ ì•Šì€ JSON í˜•ì‹ì…ë‹ˆë‹¤: {str(e)}")
                            except Exception as e:
                                st.error(f"ì €ì¥ ì˜¤ë¥˜: {str(e)}")
                else:
                    st.info("ë“±ë¡ëœ ìƒí’ˆì´ ì—†ìŠµë‹ˆë‹¤.")
            except Exception as e:
                st.error(f"ìƒí’ˆ ì¡°íšŒ ì˜¤ë¥˜: {str(e)}")
                st.info("ğŸ’¡ í™•ì¸ì‚¬í•­:\n- Supabase ì—°ê²° ìƒíƒœë¥¼ í™•ì¸í•˜ì„¸ìš”.\n- ë°ì´í„°ë² ì´ìŠ¤ í…Œì´ë¸”ì´ ì¡´ì¬í•˜ëŠ”ì§€ í™•ì¸í•˜ì„¸ìš”.")
    
    # Tab 3: ìƒë‹´ ì´ë ¥ ì¡°íšŒ
    with tab3:
        st.subheader("ğŸ“‹ ìƒë‹´ ì´ë ¥ ì¡°íšŒ")
        
        if not supabase:
            st.error("Supabase ì—°ê²°ì´ í•„ìš”í•©ë‹ˆë‹¤.")
        else:
            search_name = st.text_input("ê³ ê°ëª… ê²€ìƒ‰", key="search_customer")
            
            try:
                query = supabase.table("consulting_history").select("*, insurance_products(*)").order("created_at", desc=True)
                
                if search_name:
                    query = query.ilike("customer_name", f"%{search_name}%")
                
                history = query.execute()
                
                if history.data:
                    st.subheader(f"ìƒë‹´ ì´ë ¥ ({len(history.data)}ê±´)")
                    
                    for idx, item in enumerate(history.data):
                        with st.expander(f"ğŸ“Œ {item.get('customer_name', 'N/A')} - {item.get('created_at', '')[:10]} - {item.get('agent_name', 'N/A')}"):
                            col1, col2 = st.columns(2)
                            
                            with col1:
                                st.write(f"**ê³ ê°ëª…:** {item.get('customer_name', 'N/A')}")
                                st.write(f"**ì„¤ê³„ì‚¬:** {item.get('agent_name', 'N/A')}")
                                st.write(f"**ìƒë‹´ì¼:** {item.get('created_at', 'N/A')}")
                                
                                if item.get('insurance_products'):
                                    product = item['insurance_products']
                                    st.write(f"**ì¶”ì²œ ìƒí’ˆ:** {product.get('product_name', 'N/A')} ({product.get('company', 'N/A')})")
                            
                            with col2:
                                st.subheader("ë¶„ì„ ê²°ê³¼")
                                analysis_result = item.get('analysis_result', {})
                                st.json(analysis_result)
                                
                                # ë¹„êµ ë¦¬í¬íŠ¸ì™€ ì°¨íŠ¸ ë³µì›
                                if analysis_result and 'comparison' in analysis_result:
                                    st.markdown("---")
                                    st.subheader("ğŸ“Š ë¹„êµ ë¦¬í¬íŠ¸ ë³µì›")
                                    
                                    comparison = analysis_result.get('comparison', {})
                                    
                                    # ì§„ë‹¨ë¹„ ë¹„êµ ì°¨íŠ¸ ìƒì„±
                                    chart_data = []
                                    for key in ['ì•”ì§„ë‹¨ë¹„_ì°¨ì´', 'ë‡Œì§„ë‹¨ë¹„_ì°¨ì´', 'ì‹¬ì¥ì§„ë‹¨ë¹„_ì°¨ì´', 'ìˆ˜ìˆ ë¹„_ì°¨ì´']:
                                        if key in comparison:
                                            diff_data = comparison[key]
                                            chart_data.append({
                                                'ë³´ì¥í•­ëª©': key.replace('_ì°¨ì´', ''),
                                                'í˜„ì¬': _extract_amount(diff_data.get('í˜„ì¬', '0')),
                                                'ì‹ ê·œ': _extract_amount(diff_data.get('ì‹ ê·œ', '0'))
                                            })
                                    
                                    if chart_data:
                                        df_chart = pd.DataFrame(chart_data)
                                        fig = px.bar(df_chart, x='ë³´ì¥í•­ëª©', y=['í˜„ì¬', 'ì‹ ê·œ'], 
                                                    barmode='group', title="ë³´ì¥ê¸ˆì•¡ ë¹„êµ",
                                                    labels={'value': 'ê¸ˆì•¡ (ë§Œì›)', 'variable': 'êµ¬ë¶„'},
                                                    color_discrete_map={'í˜„ì¬': '#FF6B6B', 'ì‹ ê·œ': '#4ECDC4'})
                                        st.plotly_chart(fig, use_container_width=True)
                                    
                                    # ì¶”ì²œ ì‚¬í•­ í‘œì‹œ
                                    if 'recommendation' in analysis_result:
                                        st.markdown("### ğŸ’¡ ì¶”ì²œ ì‚¬í•­")
                                        st.info(analysis_result['recommendation'])
                else:
                    st.info("ìƒë‹´ ì´ë ¥ì´ ì—†ìŠµë‹ˆë‹¤.")
            except Exception as e:
                st.error(f"ì´ë ¥ ì¡°íšŒ ì˜¤ë¥˜: {str(e)}")
                st.info("ğŸ’¡ í™•ì¸ì‚¬í•­:\n- Supabase ì—°ê²° ìƒíƒœë¥¼ í™•ì¸í•˜ì„¸ìš”.\n- ë°ì´í„°ë² ì´ìŠ¤ í…Œì´ë¸”ì´ ì¡´ì¬í•˜ëŠ”ì§€ í™•ì¸í•˜ì„¸ìš”.")

# ì„¤ê³„ì‚¬ ëª¨ë“œ
elif mode == "ì„¤ê³„ì‚¬ ëª¨ë“œ (Agent)":
    st.title("ğŸ‘¨â€ğŸ’¼ ì„¤ê³„ì‚¬ ëª¨ë“œ")
    st.markdown("---")
    
    # Step í‘œì‹œ
    if 'current_step' not in st.session_state:
        st.session_state['current_step'] = 1
    
    steps = ["Step 1: ê³ ê° ì •ë³´ ë° íŒŒì¼ ì…ë ¥", "Step 2: ë¹„êµ ëŒ€ìƒ ì„ íƒ", "Step 3: AI ì •ë°€ ë¹„êµ ë° ì‹œê°í™”", "Step 4: ê²°ê³¼ ì €ì¥"]
    current_step = st.session_state['current_step']
    
    # ì§„í–‰ ìƒí™© í‘œì‹œ
    progress = current_step / len(steps)
    st.progress(progress)
    st.caption(f"ì§„í–‰ ìƒí™©: {current_step}/{len(steps)}")
    
    # Step 1: ê³ ê° ì •ë³´ ë° íŒŒì¼ ì…ë ¥
    if current_step == 1:
        st.subheader("Step 1: ê³ ê° ì •ë³´ ë° íŒŒì¼ ì…ë ¥")
        
        col1, col2 = st.columns(2)
        with col1:
            customer_name = st.text_input("ê³ ê°ëª…", value=st.session_state.get('customer_name', ''), key="customer_name_input")
            st.session_state['customer_name'] = customer_name
        with col2:
            gender = st.selectbox("ì„±ë³„", ["ë‚¨", "ì—¬"], index=0 if st.session_state.get('gender', 'ë‚¨') == 'ë‚¨' else 1, key="gender_input")
            st.session_state['gender'] = gender
        
        col3, col4 = st.columns(2)
        with col3:
            customer_age = st.number_input("ë‚˜ì´", min_value=0, max_value=120, value=st.session_state.get('customer_age', 0), key="customer_age_input")
            st.session_state['customer_age'] = customer_age
        with col4:
            monthly_income = st.number_input("ì›”ìˆ˜ì… (ë§Œì›)", min_value=0, value=st.session_state.get('monthly_income', 0), key="monthly_income_input")
            st.session_state['monthly_income'] = monthly_income
        
        agent_name = st.text_input("ì„¤ê³„ì‚¬ëª…", value=st.session_state.get('agent_name', ''), key="agent_name_input")
        st.session_state['agent_name'] = agent_name
        
        uploaded_file = st.file_uploader("ê³ ê°ì˜ ë³´ì¥ë¶„ì„ ë¦¬í¬íŠ¸ PDF ì—…ë¡œë“œ", type=["pdf"], key="customer_pdf")
        
        # ì„¸ì…˜ ìƒíƒœ ì´ˆê¸°í™”
        if 'customer_extracted_text' not in st.session_state:
            st.session_state['customer_extracted_text'] = None
        if 'customer_file_name' not in st.session_state:
            st.session_state['customer_file_name'] = None
        if 'customer_analysis' not in st.session_state:
            st.session_state['customer_analysis'] = None
        if 'customer_is_analyzing' not in st.session_state:
            st.session_state['customer_is_analyzing'] = False
        
        # íŒŒì¼ì´ ìƒˆë¡œ ì—…ë¡œë“œëœ ê²½ìš° (ì´ì „ íŒŒì¼ê³¼ ë‹¤ë¥¸ ê²½ìš°ì—ë§Œ ì¶”ì¶œ)
        if uploaded_file is not None:
            current_file_name = uploaded_file.name
            saved_file_name = st.session_state.get('customer_file_name')
            
            # ìƒˆ íŒŒì¼ì´ê±°ë‚˜ ì•„ì§ ì¶”ì¶œí•˜ì§€ ì•Šì€ ê²½ìš°ì—ë§Œ í…ìŠ¤íŠ¸ ì¶”ì¶œ
            if current_file_name != saved_file_name or st.session_state.get('customer_extracted_text') is None:
                pdf_bytes = uploaded_file.read()
                text = extract_text_from_pdf(pdf_bytes, uploaded_file.name)
                
                # ì„¸ì…˜ ìƒíƒœì— ì €ì¥
                st.session_state['customer_extracted_text'] = text
                st.session_state['customer_file_name'] = uploaded_file.name
                # ìƒˆ íŒŒì¼ì´ ì—…ë¡œë“œë˜ë©´ ì´ì „ ë¶„ì„ ê²°ê³¼ ì´ˆê¸°í™”
                st.session_state['customer_analysis'] = None
                st.session_state['customer_is_analyzing'] = False
        
        # ì„¸ì…˜ ìƒíƒœì—ì„œ í…ìŠ¤íŠ¸ ê°€ì ¸ì˜¤ê¸°
        text = st.session_state.get('customer_extracted_text')
        file_name = st.session_state.get('customer_file_name')
        customer_analysis = st.session_state.get('customer_analysis')
        is_analyzing = st.session_state.get('customer_is_analyzing', False)
        
        if text:
            st.success(f"âœ… í…ìŠ¤íŠ¸ ì¶”ì¶œ ì™„ë£Œ ({len(text):,}ì)" + (f" - íŒŒì¼: {file_name}" if file_name else ""))
            
            # ë¶„ì„ ê²°ê³¼ê°€ ì´ë¯¸ ìˆìœ¼ë©´ í‘œì‹œ
            if customer_analysis:
                st.subheader("ğŸ“Š ê³ ê° ë³´ì¥ë¶„ì„ ê²°ê³¼ (AS-IS)")
                
                # ê³ ê° í”„ë¡œí•„ ì •ë³´ í‘œì‹œ
                if 'customer_profile' in customer_analysis:
                    profile = customer_analysis['customer_profile']
                    monthly_income = st.session_state.get('monthly_income', 0)
                    total_premium = profile.get('total_monthly_premium', 0)
                    premium_ratio = profile.get('premium_ratio', 0)
                    premium_status = profile.get('premium_status', 'N/A')
                    
                    # premium_ratioê°€ ì—†ìœ¼ë©´ ê³„ì‚°
                    if premium_ratio == 0 and monthly_income > 0 and total_premium > 0:
                        premium_ratio = (total_premium / (monthly_income * 10000)) * 100
                    
                    col1, col2, col3, col4 = st.columns(4)
                    with col1:
                        st.metric("ê³ ê°ëª…", profile.get('name', 'N/A'))
                    with col2:
                        st.metric("ë‚˜ì´", f"{profile.get('age', 0)}ì„¸")
                    with col3:
                        st.metric("ì›” ì´ ë‚©ì… ë³´í—˜ë£Œ", f"{total_premium:,}ì›")
                    with col4:
                        if monthly_income > 0:
                            st.metric("ì›”ìˆ˜ì… ëŒ€ë¹„ ë¹„ìœ¨", f"{premium_ratio:.1f}%")
                    
                    # ë³´í—˜ë£Œ ì ì •ì„± í‰ê°€
                    if monthly_income > 0:
                        st.markdown("---")
                        col1, col2 = st.columns(2)
                        with col1:
                            st.write(f"**ì›”ìˆ˜ì…:** {monthly_income:,}ë§Œì›")
                            st.write(f"**ì›” ë³´í—˜ë£Œ:** {total_premium:,}ì›")
                            st.write(f"**ë³´í—˜ë£Œ ë¹„ìœ¨:** {premium_ratio:.1f}%")
                        
                        with col2:
                            if premium_status == 'ë¶€ì¡±':
                                st.warning(f"âš ï¸ **ë³´í—˜ë£Œ ìƒíƒœ: ë¶€ì¡±** (í‰ê·  8~12% ëŒ€ë¹„ {premium_ratio:.1f}%ë¡œ ë¶€ì¡±)")
                                st.info("ğŸ’¡ ì¼ë°˜ì ìœ¼ë¡œ ì›”ìˆ˜ì…ì˜ 8~12%ê°€ ì ì • ë³´í—˜ë£Œ ë¹„ìœ¨ì…ë‹ˆë‹¤. í˜„ì¬ ë³´í—˜ë£Œê°€ ë¶€ì¡±í•˜ì—¬ ë³´ì¥ ê³µë°±ì´ ìˆì„ ìˆ˜ ìˆìŠµë‹ˆë‹¤.")
                            elif premium_status == 'ì ì •':
                                st.success(f"âœ… **ë³´í—˜ë£Œ ìƒíƒœ: ì ì •** (í‰ê·  8~12% ë²”ìœ„ ë‚´)")
                                st.info("ğŸ’¡ ë³´í—˜ë£Œ ë¹„ìœ¨ì´ ì ì • ë²”ìœ„ì— ìˆìŠµë‹ˆë‹¤. ë‹¤ë§Œ ë³´ì¥ ë‚´ìš©ì˜ ì¶©ë¶„ì„±ì„ í™•ì¸í•´ì•¼ í•©ë‹ˆë‹¤.")
                            elif premium_status == 'ê³¼ë‹¤':
                                st.error(f"ğŸ”´ **ë³´í—˜ë£Œ ìƒíƒœ: ê³¼ë‹¤** (í‰ê·  8~12% ëŒ€ë¹„ {premium_ratio:.1f}%ë¡œ ê³¼ë‹¤)")
                                st.warning("âš ï¸ ë³´í—˜ë£Œê°€ ê³¼ë‹¤í•˜ì—¬ ì¬ì • ë¶€ë‹´ì´ í´ ìˆ˜ ìˆìŠµë‹ˆë‹¤. ë³´ì¥ ë‚´ìš©ì„ ì¬ê²€í† í•˜ê±°ë‚˜ ë¶ˆí•„ìš”í•œ ë³´í—˜ì„ ì •ë¦¬í•˜ëŠ” ê²ƒì„ ê³ ë ¤í•´ë³´ì„¸ìš”.")
                            else:
                                if premium_ratio < 8:
                                    st.warning(f"âš ï¸ **ë³´í—˜ë£Œ ìƒíƒœ: ë¶€ì¡±** (í‰ê·  8~12% ëŒ€ë¹„ {premium_ratio:.1f}%ë¡œ ë¶€ì¡±)")
                                elif premium_ratio > 12:
                                    st.error(f"ğŸ”´ **ë³´í—˜ë£Œ ìƒíƒœ: ê³¼ë‹¤** (í‰ê·  8~12% ëŒ€ë¹„ {premium_ratio:.1f}%ë¡œ ê³¼ë‹¤)")
                                else:
                                    st.success(f"âœ… **ë³´í—˜ë£Œ ìƒíƒœ: ì ì •** (í‰ê·  8~12% ë²”ìœ„ ë‚´)")
                    
                    st.markdown("---")
                
                # í˜„ì¬ ê°€ì… ë³´í—˜ ëª©ë¡ í‘œì‹œ
                if 'insurance_list' in customer_analysis and customer_analysis['insurance_list']:
                    st.subheader("ğŸ“‹ í˜„ì¬ ê°€ì… ë³´í—˜ ëª©ë¡")
                    insurance_list = customer_analysis['insurance_list']
                    
                    for idx, insurance in enumerate(insurance_list, 1):
                        with st.expander(f"ğŸ“Œ {idx}. {insurance.get('insurance_name', 'N/A')}", expanded=False):
                            col1, col2 = st.columns(2)
                            
                            with col1:
                                st.write(f"**ë³´í—˜ ì¢…ë¥˜:** {insurance.get('insurance_type', 'N/A')}")
                                st.write(f"**ë‚©ì…ê¸°ê°„:** {insurance.get('payment_period', 'N/A')}")
                                st.write(f"**ë³´í—˜ê¸°ê°„:** {insurance.get('coverage_period', 'N/A')}")
                                st.write(f"**ì›” ë³´í—˜ë£Œ:** {insurance.get('monthly_premium', 0):,}ì›")
                            
                            with col2:
                                st.write("**ë³´í—˜ ì„¤ëª…:**")
                                st.write(insurance.get('description', 'N/A'))
                    
                    # ë³´í—˜ ëª©ë¡ ìš”ì•½ í…Œì´ë¸”
                    insurance_summary = []
                    for insurance in insurance_list:
                        insurance_summary.append({
                            'ë³´í—˜ëª…': insurance.get('insurance_name', 'N/A'),
                            'ë³´í—˜ ì¢…ë¥˜': insurance.get('insurance_type', 'N/A'),
                            'ë‚©ì…ê¸°ê°„': insurance.get('payment_period', 'N/A'),
                            'ë³´í—˜ê¸°ê°„': insurance.get('coverage_period', 'N/A'),
                            'ì›” ë³´í—˜ë£Œ': f"{insurance.get('monthly_premium', 0):,}ì›"
                        })
                    
                    df_insurance = pd.DataFrame(insurance_summary)
                    st.dataframe(df_insurance, use_container_width=True)
                    st.markdown("---")
                
                # ë³´ì¥ ìƒíƒœ ìš”ì•½ í‘œì‹œ
                if 'coverage_status' in customer_analysis:
                    st.subheader("ğŸ“‹ ì£¼ìš” ë³´ì¥ í˜„í™©")
                    coverage = customer_analysis['coverage_status']
                    
                    col1, col2 = st.columns(2)
                    with col1:
                        if 'cancer' in coverage:
                            cancer = coverage['cancer']
                            st.write(f"**ì•” ì§„ë‹¨ë¹„:** ì¼ë°˜ì•” {cancer.get('general_amount', 0)}ë§Œì›, ìœ ì‚¬ì•” {cancer.get('micro_amount', 0)}ë§Œì›")
                            st.write(f"**ì¶©ë¶„ì„±:** {'âœ… ì¶©ë¶„' if cancer.get('is_sufficient', False) else 'âš ï¸ ë¶€ì¡±'}")
                        
                        if 'brain' in coverage:
                            brain = coverage['brain']
                            st.write(f"**ë‡Œ ì§ˆí™˜:** ì¶œí˜ˆ {brain.get('hemorrhage_amount', 0)}ë§Œì›, ë‡Œì¡¸ì¤‘ {brain.get('stroke_amount', 0)}ë§Œì›, ë‡Œí˜ˆê´€ {brain.get('vascular_amount', 0)}ë§Œì›")
                            if brain.get('diagnosis'):
                                st.info(f"ğŸ’¡ {brain.get('diagnosis')}")
                    
                    with col2:
                        if 'heart' in coverage:
                            heart = coverage['heart']
                            st.write(f"**ì‹¬ì¥ ì§ˆí™˜:** ê¸‰ì„±ì‹¬ê·¼ê²½ìƒ‰ {heart.get('acute_amount', 0)}ë§Œì›, í—ˆí˜ˆì„± {heart.get('ischemic_amount', 0)}ë§Œì›")
                            if heart.get('diagnosis'):
                                st.info(f"ğŸ’¡ {heart.get('diagnosis')}")
                        
                        if 'surgery' in coverage:
                            surgery = coverage['surgery']
                            st.write(f"**ìˆ˜ìˆ ë¹„:** ì§ˆë³‘ {surgery.get('disease_surgery_amount', 0)}ë§Œì›, ìƒí•´ {surgery.get('injury_surgery_amount', 0)}ë§Œì›")
                
                # ì•½ì  í‘œì‹œ
                if 'weak_points' in customer_analysis and customer_analysis['weak_points']:
                    st.subheader("âš ï¸ ë³´ì¥ ì•½ì  ë¶„ì„")
                    for point in customer_analysis['weak_points']:
                        st.warning(f"â€¢ {point}")
                
                # ì „ì²´ JSON í‘œì‹œ
                with st.expander("ğŸ“„ ì „ì²´ ë¶„ì„ ê²°ê³¼ (JSON)"):
                    st.json(customer_analysis)
                
                st.success("âœ… ë¶„ì„ ì™„ë£Œ! ë‹¤ìŒ ë‹¨ê³„ë¡œ ì§„í–‰í•˜ì„¸ìš”.")
                
                if st.button("ë‹¤ìŒ ë‹¨ê³„ë¡œ", type="primary", key="step1_next"):
                    st.session_state['current_step'] = 2
                    st.rerun()
            
            # ë¶„ì„ ì¤‘ì´ë©´ í‘œì‹œ
            elif is_analyzing:
                st.info("ğŸ”„ ë¶„ì„ì´ ì§„í–‰ ì¤‘ì…ë‹ˆë‹¤...")
            
            # ë¶„ì„ ê²°ê³¼ê°€ ì—†ê³  ë¶„ì„ ì¤‘ì´ ì•„ë‹ˆë©´ ë¶„ì„ ì‹œì‘ ë²„íŠ¼ í‘œì‹œ
            elif not customer_analysis and not is_analyzing:
                if st.button("ğŸ¤– ê³ ê° ë³´ì¥ë¶„ì„ ë¦¬í¬íŠ¸ ë¶„ì„ ì‹œì‘ (AS-IS)", key="analyze_customer", type="primary", use_container_width=True):
                    # ê³ ê° ì •ë³´ ìˆ˜ì§‘
                    customer_info = {
                        "name": st.session_state.get('customer_name', ''),
                        "gender": st.session_state.get('gender', ''),
                        "age": st.session_state.get('customer_age', 0),
                        "monthly_income": st.session_state.get('monthly_income', 0)
                    }
                    
                    # ê³ ê° ì •ë³´ ê²€ì¦
                    if not customer_info['name']:
                        st.error("âš ï¸ ê³ ê°ëª…ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.")
                    elif not customer_info['gender']:
                        st.error("âš ï¸ ì„±ë³„ì„ ì„ íƒí•´ì£¼ì„¸ìš”.")
                    elif customer_info['age'] == 0:
                        st.error("âš ï¸ ë‚˜ì´ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.")
                    else:
                        st.session_state['customer_is_analyzing'] = True
                        st.rerun()
            
            # ë¶„ì„ ì§„í–‰ ì¤‘ì¼ ë•Œ
            if is_analyzing:
                with st.spinner("ğŸ”„ AI ë¶„ì„ ì¤‘... (ê³ ê°ì˜ í˜„ì¬ ë³´í—˜ ìƒíƒœë¥¼ ì •ë°€ ë¶„ì„ ì¤‘ì…ë‹ˆë‹¤)"):
                    try:
                        analysis_result = analyze_customer_policy(text, {
                            "name": st.session_state.get('customer_name', ''),
                            "gender": st.session_state.get('gender', ''),
                            "age": st.session_state.get('customer_age', 0),
                            "monthly_income": st.session_state.get('monthly_income', 0)
                        })
                        
                        # ë¶„ì„ ì™„ë£Œ í”Œë˜ê·¸ í•´ì œ
                        st.session_state['customer_is_analyzing'] = False
                        
                        if analysis_result:
                            # ì„¸ì…˜ ìƒíƒœì— ì €ì¥
                            st.session_state['customer_analysis'] = analysis_result
                            st.success("âœ… ë¶„ì„ ì™„ë£Œ!")
                            st.rerun()
                        else:
                            st.error("âŒ ë¶„ì„ ê²°ê³¼ë¥¼ ë°›ì§€ ëª»í–ˆìŠµë‹ˆë‹¤.")
                    except Exception as e:
                        st.session_state['customer_is_analyzing'] = False
                        st.error(f"âŒ ë¶„ì„ ì¤‘ ì˜¤ë¥˜ ë°œìƒ: {str(e)}")
                        import traceback
                        with st.expander("ğŸ” ìƒì„¸ ì—ëŸ¬ ì •ë³´"):
                            st.code(traceback.format_exc())
    
    # Step 2: ì „ì²´ ìƒí’ˆ ë¹„êµ ë¶„ì„
    elif current_step == 2:
        st.subheader("Step 2: ì „ì²´ ìƒí’ˆ ë¹„êµ ë¶„ì„")
        
        if 'customer_analysis' not in st.session_state:
            st.warning("âš ï¸ ë¨¼ì € Step 1ì—ì„œ ê³ ê°ì˜ ë³´í—˜ì„ ë¶„ì„í•´ì£¼ì„¸ìš”.")
            if st.button("Step 1ë¡œ ëŒì•„ê°€ê¸°", key="back_to_step1"):
                st.session_state['current_step'] = 1
                st.rerun()
        elif not supabase:
            st.error("Supabase ì—°ê²°ì´ í•„ìš”í•©ë‹ˆë‹¤.")
        else:
            try:
                products = supabase.table("insurance_products").select("*").execute()
                
                if not products.data:
                    st.warning("âš ï¸ ë“±ë¡ëœ ìƒí’ˆì´ ì—†ìŠµë‹ˆë‹¤. ê´€ë¦¬ì ëª¨ë“œì—ì„œ ìƒí’ˆì„ ë¨¼ì € ë“±ë¡í•´ì£¼ì„¸ìš”.")
                else:
                    st.info(f"ğŸ“‹ ê³ ê°ì˜ í˜„ì¬ ë³´ì¥ ë‚´ì—­ê³¼ {len(products.data)}ê°œ ìƒí’ˆì„ ë¹„êµ ë¶„ì„í•©ë‹ˆë‹¤.")
                    
                    # ì„¸ì…˜ ìƒíƒœ ì´ˆê¸°í™”
                    if 'all_comparison_results' not in st.session_state:
                        st.session_state['all_comparison_results'] = None
                    if 'is_comparing_all' not in st.session_state:
                        st.session_state['is_comparing_all'] = False
                    
                    is_comparing = st.session_state.get('is_comparing_all', False)
                    all_results = st.session_state.get('all_comparison_results')
                    
                    # ë¹„êµ ë¶„ì„ ì‹œì‘ ë²„íŠ¼
                    if not all_results and not is_comparing:
                        if st.button("ğŸ” ì „ì²´ ìƒí’ˆ ë¹„êµ ë¶„ì„ ì‹œì‘", key="compare_all_products", type="primary", use_container_width=True):
                            st.session_state['is_comparing_all'] = True
                            st.rerun()
                    
                    # ë¹„êµ ë¶„ì„ ì§„í–‰ ì¤‘
                    if is_comparing:
                        with st.spinner(f"ğŸ”„ {len(products.data)}ê°œ ìƒí’ˆê³¼ ë¹„êµ ë¶„ì„ ì¤‘... (ì‹œê°„ì´ ê±¸ë¦´ ìˆ˜ ìˆìŠµë‹ˆë‹¤)"):
                            customer_profile = {
                                "age": st.session_state.get('customer_age', 0),
                                "gender": st.session_state.get('gender', ''),
                                "monthly_income": st.session_state.get('monthly_income', 0)
                            }
                            
                            comparison_results = []
                            for idx, product in enumerate(products.data):
                                try:
                                    st.write(f"ğŸ“Š {idx + 1}/{len(products.data)}: {product.get('product_name', 'N/A')} ë¶„ì„ ì¤‘...")
                                    result = compare_products(
                                        st.session_state['customer_analysis'],
                                        product.get('analysis_data', {}),
                                        customer_profile
                                    )
                                    if result:
                                        result['product_id'] = product['id']
                                        result['product_name'] = product.get('product_name', 'N/A')
                                        result['company'] = product.get('company', 'N/A')
                                        comparison_results.append(result)
                                except Exception as e:
                                    st.warning(f"âš ï¸ {product.get('product_name', 'N/A')} ë¶„ì„ ì¤‘ ì˜¤ë¥˜: {str(e)}")
                                    continue
                            
                            # ìš°ì„ ìˆœìœ„ ì ìˆ˜ë¡œ ì •ë ¬
                            comparison_results.sort(key=lambda x: x.get('priority_score', 0), reverse=True)
                            
                            # ì¢…í•© ë¶„ì„ ë° ìµœì¢… ì¶”ì²œ ìƒì„±
                            final_recommendation = _generate_final_recommendation(
                                st.session_state['customer_analysis'],
                                comparison_results,
                                customer_profile
                            )
                            
                            st.session_state['all_comparison_results'] = comparison_results
                            st.session_state['final_recommendation_summary'] = final_recommendation
                            st.session_state['is_comparing_all'] = False
                            st.success(f"âœ… {len(comparison_results)}ê°œ ìƒí’ˆ ë¹„êµ ë¶„ì„ ì™„ë£Œ!")
                            st.rerun()
                    
                    # ë¹„êµ ê²°ê³¼ í‘œì‹œ
                    if all_results:
                        st.subheader("ğŸ“Š ì „ì²´ ìƒí’ˆ ë¹„êµ ë¶„ì„ ê²°ê³¼")
                        
                        # ìµœì¢… ì¶”ì²œ í‘œì‹œ (ê°€ì¥ ë¨¼ì € í‘œì‹œ)
                        final_recommendation = st.session_state.get('final_recommendation_summary')
                        if final_recommendation:
                            st.markdown("---")
                            
                            # í˜„ì¬ vs ì‹ ê·œ ë¹„êµ
                            if 'current_vs_new_comparison' in final_recommendation:
                                comparison = final_recommendation['current_vs_new_comparison']
                                st.markdown("### ğŸ“Š í˜„ì¬ ë³´í—˜ vs ì‹ ê·œ ìƒí’ˆ ë¹„êµ")
                                col1, col2 = st.columns(2)
                                
                                with col1:
                                    st.markdown("#### âœ… í˜„ì¬ ë³´í—˜ì´ ë” ë‚˜ì€ ì ")
                                    current_adv = comparison.get('current_advantages', [])
                                    if current_adv:
                                        for adv in current_adv:
                                            st.success(f"â€¢ {adv}")
                                    else:
                                        st.info("í˜„ì¬ ë³´í—˜ì´ ë” ë‚˜ì€ ì ì´ ì—†ìŠµë‹ˆë‹¤.")
                                
                                with col2:
                                    st.markdown("#### ğŸ†• ì‹ ê·œ ìƒí’ˆì´ ë” ë‚˜ì€ ì ")
                                    new_adv = comparison.get('new_advantages', [])
                                    if new_adv:
                                        for adv in new_adv:
                                            st.warning(f"â€¢ {adv}")
                                    else:
                                        st.info("ì‹ ê·œ ìƒí’ˆì´ ë” ë‚˜ì€ ì ì´ ì—†ìŠµë‹ˆë‹¤.")
                                
                                # ì „ì²´ ìŠ¹ì í‘œì‹œ
                                overall_winner = comparison.get('overall_winner', '')
                                if overall_winner:
                                    st.markdown("---")
                                    if overall_winner == 'í˜„ì¬':
                                        st.success(f"ğŸ† **ì¢…í•© íŒë‹¨: í˜„ì¬ ë³´í—˜ì´ ë” ìœ ë¦¬í•©ë‹ˆë‹¤**")
                                    elif overall_winner == 'ì‹ ê·œ':
                                        st.warning(f"ğŸ† **ì¢…í•© íŒë‹¨: ì‹ ê·œ ìƒí’ˆì´ ë” ìœ ë¦¬í•©ë‹ˆë‹¤**")
                            
                            # ì¶”ì²œ ìƒí’ˆ ì •ë³´
                            if 'recommended_product' in final_recommendation:
                                rec_product = final_recommendation['recommended_product']
                                if rec_product.get('product_name'):
                                    st.markdown("---")
                                    st.markdown("### ğŸŒŸ ì¶”ì²œ ìƒí’ˆ")
                                    col1, col2, col3 = st.columns(3)
                                    with col1:
                                        st.metric("ìƒí’ˆëª…", rec_product.get('product_name', 'N/A'))
                                    with col2:
                                        st.metric("ë³´í—˜ì‚¬", rec_product.get('company', 'N/A'))
                                    with col3:
                                        st.metric("ìš°ì„ ìˆœìœ„ ì ìˆ˜", f"{rec_product.get('priority_score', 0)}/100")
                            
                            # ì¶”ì²œ ìƒì„¸ (ìµœì¢… ê²°ë¡  í¬í•¨)
                            if 'recommendation_details' in final_recommendation:
                                details = final_recommendation['recommendation_details']
                                
                                st.markdown("---")
                                st.markdown("## ğŸ¯ ìµœì¢… ì¶”ì²œ ê²°ë¡ ")
                                
                                verdict = final_recommendation.get('final_verdict', 'N/A')
                                should_switch = details.get('should_switch', False)
                                
                                # ê²°ë¡ ì— ë”°ë¥¸ ê°•ì¡° í‘œì‹œ
                                if 'ìœ ì§€' in verdict and 'ì¶”ê°€' not in verdict:
                                    st.success(f"## âœ… **ìµœì¢… ê²°ë¡ : {verdict}**")
                                elif 'ì „í™˜' in verdict:
                                    st.warning(f"## ğŸ”„ **ìµœì¢… ê²°ë¡ : {verdict}**")
                                elif 'ì¶”ê°€' in verdict:
                                    st.info(f"## â• **ìµœì¢… ê²°ë¡ : {verdict}**")
                                else:
                                    st.info(f"## ğŸ“‹ **ìµœì¢… ê²°ë¡ : {verdict}**")
                                
                                st.markdown("---")
                                st.markdown("### ğŸ“‹ ì¶”ì²œ ìƒì„¸")
                                
                                if should_switch:
                                    st.warning(f"### ğŸ”„ **ì „í™˜ ê¶Œì¥**")
                                    st.write(f"**ì´ìœ :** {details.get('switch_reason', 'N/A')}")
                                else:
                                    st.success(f"### âœ… **í˜„ì¬ ìœ ì§€ ê¶Œì¥**")
                                    st.write(f"**ì´ìœ :** {details.get('switch_reason', 'N/A')}")
                                
                                if details.get('expected_benefit'):
                                    st.info(f"ğŸ’¡ **ì˜ˆìƒ ì´ì :** {details.get('expected_benefit')}")
                                
                                if details.get('expected_premium_change'):
                                    st.write(f"ğŸ’° **ë³´í—˜ë£Œ ë³€í™”:** {details.get('expected_premium_change')}")
                                
                                if details.get('action_plan'):
                                    st.write(f"ğŸ“ **ì‹¤í–‰ ë°©ì•ˆ:**")
                                    st.write(details.get('action_plan'))
                                
                                if details.get('closing_ment'):
                                    st.markdown("---")
                                    st.success(f"### ğŸ’¬ **ìµœì¢… ë©”ì‹œì§€**")
                                    st.write(details.get('closing_ment'))
                            
                            st.markdown("---")
                            st.markdown("---")
                        
                        # ìƒìœ„ 5ê°œ ìƒí’ˆ ìš”ì•½ í‘œì‹œ
                        st.markdown("### ğŸ† ì¶”ì²œ ìƒí’ˆ TOP 5")
                        top_products = all_results[:5]
                        
                        for rank, result in enumerate(top_products, 1):
                            with st.expander(f"ğŸ¥‡ {rank}ìœ„: {result.get('product_name', 'N/A')} ({result.get('company', 'N/A')}) - ìš°ì„ ìˆœìœ„ ì ìˆ˜: {result.get('priority_score', 0)}/100"):
                                col1, col2 = st.columns(2)
                                
                                with col1:
                                    st.write("**ì¬ì • ì í•©ì„± ë¶„ì„**")
                                    if 'financial_diagnosis' in result:
                                        financial = result['financial_diagnosis']
                                        st.write(f"- ìƒíƒœ: {financial.get('status', 'N/A')}")
                                        st.write(f"- ì ìˆ˜: {financial.get('score', 0)}/100")
                                        st.write(f"- ë³´í—˜ë£Œ ë¹„ìœ¨: {financial.get('current_premium_ratio', 0):.1f}%")
                                        if financial.get('comment'):
                                            st.info(f"ğŸ’¡ {financial.get('comment')}")
                                
                                with col2:
                                    st.write("**ì£¼ìš” ë³´ì¥ ë¹„êµ**")
                                    if 'coverage_comparison' in result:
                                        comparison_list = result['coverage_comparison']
                                        for comp in comparison_list[:3]:  # ìƒìœ„ 3ê°œë§Œ í‘œì‹œ
                                            st.write(f"- {comp.get('category', 'N/A')}: {comp.get('verdict', 'N/A')}")
                                
                                if 'final_recommendation' in result:
                                    recommendation = result['final_recommendation']
                                    st.write(f"**ì „ëµ:** {recommendation.get('strategy', 'N/A')}")
                                    if recommendation.get('reasoning'):
                                        st.info(f"ğŸ“‹ {recommendation.get('reasoning')}")
                        
                        # ì „ì²´ ìƒí’ˆ ë¹„êµ í…Œì´ë¸”
                        st.markdown("### ğŸ“‹ ì „ì²´ ìƒí’ˆ ë¹„êµ ìš”ì•½")
                        comparison_summary = []
                        for result in all_results:
                            comparison_summary.append({
                                'ìˆœìœ„': all_results.index(result) + 1,
                                'ìƒí’ˆëª…': result.get('product_name', 'N/A'),
                                'ë³´í—˜ì‚¬': result.get('company', 'N/A'),
                                'ìš°ì„ ìˆœìœ„ ì ìˆ˜': result.get('priority_score', 0),
                                'ì¬ì • ì í•©ì„±': result.get('financial_diagnosis', {}).get('status', 'N/A'),
                                'ì¬ì • ì ìˆ˜': result.get('financial_diagnosis', {}).get('score', 0)
                            })
                        
                        df_summary = pd.DataFrame(comparison_summary)
                        st.dataframe(df_summary, use_container_width=True)
                        
                        # ìƒí’ˆ ì„ íƒ
                        st.markdown("### ğŸ¯ ìƒì„¸ ë¶„ì„í•  ìƒí’ˆ ì„ íƒ")
                        product_options = {f"{r.get('product_name', 'N/A')} ({r.get('company', 'N/A')})": r.get('product_id') for r in all_results}
                        selected_product_name = st.selectbox(
                            "ìƒì„¸ ë¹„êµ ë¶„ì„í•  ìƒí’ˆ ì„ íƒ", 
                            list(product_options.keys()), 
                            key="product_select_step2"
                        )
                        selected_product_id = product_options[selected_product_name]
                        
                        # ì„ íƒí•œ ìƒí’ˆ ì •ë³´ ì €ì¥
                        selected_result = next(r for r in all_results if r.get('product_id') == selected_product_id)
                        selected_product = next(p for p in products.data if p['id'] == selected_product_id)
                        st.session_state['selected_product'] = selected_product
                        st.session_state['selected_comparison_result'] = selected_result
                        
                        col1, col2 = st.columns(2)
                        with col1:
                            if st.button("ì´ì „ ë‹¨ê³„", type="secondary", key="step2_back"):
                                st.session_state['current_step'] = 1
                                st.rerun()
                        with col2:
                            if st.button("ë‹¤ìŒ ë‹¨ê³„ë¡œ (ìƒì„¸ ë¶„ì„)", type="primary", key="step2_next"):
                                st.session_state['current_step'] = 3
                                st.rerun()
                    
            except Exception as e:
                st.error(f"ì˜¤ë¥˜: {str(e)}")
                import traceback
                with st.expander("ğŸ” ìƒì„¸ ì—ëŸ¬ ì •ë³´"):
                    st.code(traceback.format_exc())
    
    # Step 3: ì„ íƒí•œ ìƒí’ˆ ìƒì„¸ ë¹„êµ ë¶„ì„
    elif current_step == 3:
        st.subheader("Step 3: ì„ íƒí•œ ìƒí’ˆ ìƒì„¸ ë¹„êµ ë¶„ì„")
        
        if 'customer_analysis' not in st.session_state or 'selected_product' not in st.session_state:
            st.warning("âš ï¸ ì´ì „ ë‹¨ê³„ë¥¼ ì™„ë£Œí•´ì£¼ì„¸ìš”.")
            if st.button("Step 1ë¡œ ëŒì•„ê°€ê¸°", key="back_to_step1_from_step3"):
                st.session_state['current_step'] = 1
                st.rerun()
        else:
            selected_product = st.session_state['selected_product']
            comparison_result = st.session_state.get('selected_comparison_result')
            
            if comparison_result:
                st.session_state['comparison_result'] = comparison_result
                
                st.subheader(f"ğŸ“Š {selected_product.get('product_name', 'N/A')} ìƒì„¸ ë¹„êµ ë¶„ì„ ê²°ê³¼")
                
                # ì¬ì • ì í•©ì„± ë¶„ì„ í‘œì‹œ
                if 'financial_diagnosis' in comparison_result:
                    financial = comparison_result['financial_diagnosis']
                    col1, col2, col3 = st.columns(3)
                    with col1:
                        status = financial.get('status', 'N/A')
                        status_color = {'ë¶€ì¡±': 'ğŸ”´', 'ì ì •': 'ğŸŸ¢', 'ê³¼ë‹¤': 'ğŸŸ¡'}.get(status, 'âšª')
                        st.metric("ì¬ì • ì í•©ì„±", f"{status_color} {status}")
                    with col2:
                        score = financial.get('score', 0)
                        st.metric("ì¬ì • ì í•©ì„± ì ìˆ˜", f"{score}/100")
                    with col3:
                        current_ratio = financial.get('current_premium_ratio', 0)
                        st.metric("í˜„ì¬ ë³´í—˜ë£Œ ë¹„ìœ¨", f"{current_ratio:.1f}%")
                    
                    if financial.get('comment'):
                        st.info(f"ğŸ’¡ {financial.get('comment')}")
                
                # ìƒì•  ì£¼ê¸° ë¶„ì„ í‘œì‹œ
                if 'lifecycle_analysis' in comparison_result:
                    lifecycle = comparison_result['lifecycle_analysis']
                    st.subheader("ğŸ“‹ ìƒì•  ì£¼ê¸°ë³„ ë³´ì¥ ë¶„ì„")
                    col1, col2 = st.columns(2)
                    with col1:
                        st.write(f"**ì—°ë ¹ëŒ€:** {lifecycle.get('age_group', 'N/A')}")
                        if lifecycle.get('required_coverage'):
                            st.write("**í•„ìˆ˜ ë³´ì¥:**")
                            for coverage in lifecycle.get('required_coverage', []):
                                st.write(f"- {coverage}")
                    with col2:
                        if lifecycle.get('current_gap'):
                            st.warning(f"âš ï¸ {lifecycle.get('current_gap')}")
                        if lifecycle.get('priority_recommendation'):
                            st.info(f"ğŸ’¡ {lifecycle.get('priority_recommendation')}")
                
                # ë³´ì¥ ë¹„êµ í‘œì‹œ
                if 'coverage_comparison' in comparison_result:
                    st.subheader("ğŸ“Š ë³´ì¥ ë²”ìœ„ ë¹„êµ")
                    comparison_list = comparison_result['coverage_comparison']
                    
                    for comp in comparison_list:
                        with st.expander(f"ğŸ” {comp.get('category', 'N/A')}"):
                            col1, col2 = st.columns(2)
                            with col1:
                                st.write("**í˜„ì¬ ë³´ì¥ (AS-IS)**")
                                st.write(comp.get('asis_text', 'N/A'))
                            with col2:
                                st.write("**ì¶”ì²œ ë³´ì¥ (TO-BE)**")
                                st.write(comp.get('tobe_text', 'N/A'))
                            
                            verdict = comp.get('verdict', '')
                            if 'TO-BE ìŠ¹ë¦¬' in verdict:
                                st.success(f"âœ… {verdict}: {comp.get('reason', '')}")
                            elif 'AS-IS ìœ ë¦¬' in verdict:
                                st.info(f"â„¹ï¸ {verdict}: {comp.get('reason', '')}")
                            else:
                                st.write(f"âš–ï¸ {verdict}: {comp.get('reason', '')}")
                    
                    # ë³´ì¥ ë¹„êµ ì°¨íŠ¸ ìƒì„±
                    chart_data = []
                    for comp in comparison_list:
                        category = comp.get('category', '')
                        asis_val = _extract_amount(str(comp.get('asis_text', '0')))
                        tobe_val = _extract_amount(str(comp.get('tobe_text', '0')))
                        
                        if asis_val > 0 or tobe_val > 0:
                            chart_data.append({
                                'ë³´ì¥í•­ëª©': category,
                                'í˜„ì¬': asis_val,
                                'ì‹ ê·œ': tobe_val
                            })
                    
                    if chart_data:
                        df_chart = pd.DataFrame(chart_data)
                        fig = px.bar(df_chart, x='ë³´ì¥í•­ëª©', y=['í˜„ì¬', 'ì‹ ê·œ'], 
                                    barmode='group', title="ë³´ì¥ê¸ˆì•¡ ë¹„êµ (í˜„ì¬ vs ì‹ ê·œ)",
                                    labels={'value': 'ê¸ˆì•¡ (ë§Œì›)', 'variable': 'êµ¬ë¶„'},
                                    color_discrete_map={'í˜„ì¬': '#FF6B6B', 'ì‹ ê·œ': '#4ECDC4'})
                        st.plotly_chart(fig, use_container_width=True)
                
                # ìµœì¢… ì¶”ì²œ í‘œì‹œ
                if 'final_recommendation' in comparison_result:
                    st.subheader("ğŸ’¡ ìµœì¢… ë¦¬ëª¨ë¸ë§ ì œì•ˆ")
                    recommendation = comparison_result['final_recommendation']
                    
                    col1, col2 = st.columns(2)
                    with col1:
                        st.write(f"**ì „ëµ:** {recommendation.get('strategy', 'N/A')}")
                        if recommendation.get('expected_premium'):
                            st.metric("ì˜ˆìƒ ë³´í—˜ë£Œ", f"{recommendation.get('expected_premium')}ë§Œì›")
                    with col2:
                        if recommendation.get('reasoning'):
                            st.info(f"ğŸ“‹ {recommendation.get('reasoning')}")
                    
                    if recommendation.get('closing_ment'):
                        st.success(f"ğŸ’¬ {recommendation.get('closing_ment')}")
                
                # ìš°ì„ ìˆœìœ„ ì ìˆ˜
                if 'priority_score' in comparison_result:
                    score = comparison_result['priority_score']
                    st.metric("ì¶”ì²œ ìš°ì„ ìˆœìœ„ ì ìˆ˜", f"{score}/100")
                
                # ì „ì²´ JSON í‘œì‹œ (ì ‘ì„ ìˆ˜ ìˆê²Œ)
                with st.expander("ğŸ“„ ì „ì²´ ë¶„ì„ ê²°ê³¼ (JSON)"):
                    st.json(comparison_result)
                
                col1, col2 = st.columns(2)
                with col1:
                    if st.button("ì´ì „ ë‹¨ê³„", type="secondary", key="step3_back"):
                        st.session_state['current_step'] = 2
                        st.rerun()
                with col2:
                    if st.button("ë‹¤ìŒ ë‹¨ê³„ë¡œ", type="primary", key="step3_next"):
                        st.session_state['current_step'] = 4
                        st.rerun()
            else:
                st.warning("âš ï¸ Step 2ì—ì„œ ìƒí’ˆì„ ì„ íƒí•˜ê³  ë¹„êµ ë¶„ì„ì„ ì™„ë£Œí•´ì£¼ì„¸ìš”.")
                if st.button("Step 2ë¡œ ëŒì•„ê°€ê¸°", key="back_to_step2_from_step3"):
                    st.session_state['current_step'] = 2
                    st.rerun()
    
    # Step 4: ê²°ê³¼ ì €ì¥
    elif current_step == 4:
        st.subheader("Step 4: ê²°ê³¼ ì €ì¥")
        
        if 'comparison_result' not in st.session_state:
            st.warning("âš ï¸ ì´ì „ ë‹¨ê³„ë¥¼ ì™„ë£Œí•´ì£¼ì„¸ìš”.")
            if st.button("Step 1ë¡œ ëŒì•„ê°€ê¸°", key="back_to_step1_from_step4"):
                st.session_state['current_step'] = 1
                st.rerun()
        else:
            st.info("ğŸ“‹ ìƒë‹´ ê²°ê³¼ë¥¼ í™•ì¸í•˜ê³  ì €ì¥í•˜ì„¸ìš”.")
            
            st.json(st.session_state['comparison_result'])
            
            if st.button("ìƒë‹´ ê²°ê³¼ ì €ì¥", type="primary", key="save_result"):
                if not supabase:
                    st.error("Supabase ì—°ê²°ì´ í•„ìš”í•©ë‹ˆë‹¤.")
                else:
                    try:
                        selected_product = st.session_state['selected_product']
                        data = {
                            "customer_name": st.session_state.get('customer_name', ''),
                            "agent_name": st.session_state.get('agent_name', ''),
                            "recommended_product_id": selected_product['id'],
                            "analysis_result": st.session_state['comparison_result'],
                            "user_id": AGENT_USER_ID
                        }
                        result = supabase.table("consulting_history").insert(data).execute()
                        st.success("âœ… ìƒë‹´ ì´ë ¥ì´ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤!")
                        st.json(result.data[0] if result.data else {})
                        
                        # ì´ˆê¸°í™” ì˜µì…˜
                        if st.button("ìƒˆ ìƒë‹´ ì‹œì‘", key="new_consultation"):
                            for key in ['customer_analysis', 'selected_product', 'comparison_result', 'current_step']:
                                if key in st.session_state:
                                    del st.session_state[key]
                            st.session_state['current_step'] = 1
                            st.rerun()
                    except Exception as e:
                        st.error(f"ì €ì¥ ì˜¤ë¥˜: {str(e)}")
                        st.info("ğŸ’¡ í™•ì¸ì‚¬í•­:\n- Supabase ì—°ê²° ìƒíƒœë¥¼ í™•ì¸í•˜ì„¸ìš”.\n- ë°ì´í„°ë² ì´ìŠ¤ í…Œì´ë¸” êµ¬ì¡°ë¥¼ í™•ì¸í•˜ì„¸ìš”.")
            
            if st.button("ì´ì „ ë‹¨ê³„", type="secondary", key="step4_back"):
                st.session_state['current_step'] = 3
                st.rerun()

# í‘¸í„°
st.sidebar.markdown("---")
st.sidebar.markdown("**Enterprise AI Insurance Analyst**")
st.sidebar.markdown("AI ê¸°ë°˜ ë³´í—˜ ë¶„ì„ ë° ì»¨ì„¤íŒ… í”Œë«í¼")
